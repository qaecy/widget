import{a as L,b as _e,c as he}from"./chunk-GSCUCMFU.js";import{c as de,d as ue}from"./chunk-MQKCRQHU.js";import"./chunk-QEBCTBUI.js";import{c as W,g as Z,i as k,j as I,k as ee,o as te}from"./chunk-QK5VUW5Z.js";import{a as fe}from"./chunk-RP6GSRQV.js";import{a as G}from"./chunk-22TYSVVA.js";import{b as ie,c as re,e as se,i as ae,l as ce,o as pe}from"./chunk-PIYCZUTI.js";import{p as le,q as me}from"./chunk-6HG62L4Z.js";import{W as ne,X as oe,Y as D,Z as F}from"./chunk-XKKDWFIZ.js";import"./chunk-HU7WFQWJ.js";import"./chunk-4HBM54OK.js";import{Ab as m,Fb as j,Ga as B,Gb as z,Hb as q,Ka as r,Mb as S,Nb as V,O as R,Qb as $,Rb as U,S as d,Sb as Q,Ta as y,Ya as v,Z as C,_ as x,bb as _,bc as f,ec as M,hb as p,ja as b,jb as A,mb as h,nb as N,pb as E,qb as O,rb as s,sb as a,tb as l,xb as T,zb as w}from"./chunk-C37SL542.js";import"./chunk-NC2NMBFO.js";import"./chunk-LOUWY4NJ.js";import"./chunk-4JUNAGW5.js";import{Ga as Y,v as J}from"./chunk-RIETPOXV.js";import"./chunk-5W727OWZ.js";import{v as K,z as X}from"./chunk-SXCIL3LG.js";import"./chunk-I7PEP2DU.js";import{h as u}from"./chunk-TJICSKBO.js";function be(t,c){if(t&1){let e=T();s(0,"div",1),w("mouseover",function(){C(e);let o=m();return x(o.onHover())})("mouseout",function(){C(e);let o=m();return x(o.onLeave())}),s(1,"span",2),S(2),a(),s(3,"span",3),S(4),a()()}if(t&2){let e=c,n=m();p("matTooltip",e.text),r(2),V(n.textShort()),r(2),V(e.label)}}var ge=(()=>{class t{data=b();textShort=f(()=>this.data()?.text?.substring(0,20)+"...");onHover(){console.log("H")}onLeave(){console.log("L")}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=v({type:t,selectors:[["app-doc-ref"]],inputs:{data:[1,"data"]},decls:1,vars:1,consts:[[1,"box",3,"matTooltip"],[1,"box",3,"mouseover","mouseout","matTooltip"],[1,"text"],[1,"label"]],template:function(n,o){if(n&1&&_(0,be,5,3,"div",0),n&2){let i;h((i=o.data())?0:-1,i)}},dependencies:[me,le],styles:[".box[_ngcontent-%COMP%]{font-size:.5rem;border-radius:.3rem;outline-color:var(--mat-sys-outline);display:flex;flex-direction:column;max-width:4rem;padding:.3rem;background-color:var(--box-bg-color);height:100%}.box[_ngcontent-%COMP%]:hover{background-color:var(--mat-sys-secondary-container)}.label[_ngcontent-%COMP%]{font-weight:700}.text[_ngcontent-%COMP%]{font-weight:400}"]})}return t})();function we(t,c){if(t&1&&l(0,"app-doc-ref",2),t&2){let e=c.$implicit;p("data",e)}}var Ce=(()=>{class t{data=b([]);static \u0275fac=function(n){return new(n||t)};static \u0275cmp=v({type:t,selectors:[["app-doc-refs"]],inputs:{data:[1,"data"]},decls:5,vars:0,consts:[[1,"ref-container"],[1,"quote"],[3,"data"]],template:function(n,o){n&1&&(s(0,"div",0)(1,"mat-icon",1),S(2,"format_quote"),a(),E(3,we,1,1,"app-doc-ref",2,N),a()),n&2&&(r(3),O(o.data()))},dependencies:[ge,F,D],styles:[".ref-container[_ngcontent-%COMP%]{padding:.6rem .2rem;position:relative;display:flex;flex-direction:row;gap:.5rem;overflow-y:auto}.quote[_ngcontent-%COMP%]{position:absolute;left:-2px;top:-2px}"]})}return t})();function Te(t,c){if(t&1&&l(0,"app-doc-refs",4),t&2){let e=m();p("data",e.docRefs())}}var xe=(()=>{class t{parsers=he;content=b.required();startPassive=b(!0);html=y("");preLoading=f(()=>{let e=this.content().responseText;return!e||e===void 0||e===""});whileLoading=f(()=>!this.content().finished);context=f(()=>this.content().context);docRefs=f(()=>{let e=this.context().refs;return e!==void 0?e:[]});onTextChange=M(()=>u(this,null,function*(){let e=this.content().responseText;if(e){let n=yield L(e);this.startPassive()===!1&&(n=this._overridePassiveMode(n)),this.html.set(n)}else this.html.set("")}));_overridePassiveMode(e){return["bim-viewer","map"].forEach(n=>{e=e.replace(`<${n}`,`<${n} [startPassive]="false"`),e=e.replace(`&lt;${n}`,`&lt;${n} [startPassive]="false"`)}),e}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=v({type:t,selectors:[["app-bot-response"]],inputs:{content:[1,"content"],startPassive:[1,"startPassive"]},decls:5,vars:8,consts:[[1,"bot-response-container"],["mode","q","size","10rem"],[1,"response"],[3,"parsers","content","context"],[3,"data"]],template:function(n,o){n&1&&(s(0,"div",0),l(1,"app-logo",1),s(2,"div",2),l(3,"ngx-dynamic-hooks",3),a(),_(4,Te,1,1,"app-doc-refs",4),a()),n&2&&(r(2),A("loader",o.preLoading())("pulse",o.whileLoading()),r(),p("parsers",o.parsers)("content",o.html())("context",o.context()),r(),h(o.docRefs()?4:-1))},dependencies:[ue,_e,Ce],styles:[".bot-response-container[_ngcontent-%COMP%]{display:flex;gap:.1rem;flex-direction:column;margin-bottom:1.5rem}.response[_ngcontent-%COMP%]{background-color:var(--box-bg-color);border-radius:.5rem;padding:0 .5rem;min-height:20px}.loader[_ngcontent-%COMP%]{width:.8rem;aspect-ratio:4;background:radial-gradient(circle closest-side,#fff 90%,#0000) 0/33.3333333333% 100% space;clip-path:inset(0 100% 0 0);animation:_ngcontent-%COMP%_l1 1s steps(4) infinite}@keyframes _ngcontent-%COMP%_l1{to{clip-path:inset(0 -34% 0 0)}}.pulse[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-animation 2s infinite}@keyframes _ngcontent-%COMP%_pulse-animation{0%{box-shadow:0 0 #0003}to{box-shadow:0 0 0 20px #0000}}"]})}return t})();var ye=(()=>{class t{_firebase=d(k);_storage=this._firebase.storageChatSessions;_collection=this._firebase.collectionChatSessions;_currentSession=y(void 0);_contextStore={};get currentSession(){return this._currentSession}subscribeToSession(e){if(this._collection===void 0)throw new Error(I.FIREBASE_NOT_INITIALIZED);console.info("Subscribing to chat session "+e),this._contextStore={};let n=J(this._collection,e);return Y(n,o=>u(this,null,function*(){if(o.exists()){let i=yield this._chatSessionFactory(o.data());this._currentSession.update(()=>i)}}))}getContextFile(e){return u(this,null,function*(){if(this._storage===void 0)throw new Error(I.FIREBASE_NOT_INITIALIZED);if(this._contextStore[e]!==void 0)return this._contextStore[e];console.info(`${e} not in store. Fetching from BLOB`);let n=K(this._storage,e),i=yield(yield X(n)).text(),g=JSON.parse(i);return this._contextStore[e]=g,g})}_chatSessionFactory(e){return u(this,null,function*(){let n=new W(e.id,e.projectId,e.userId);n.created=e.created,n.updated=e.updated;for(let o of e.entries){let i=o.context,g={};i!==void 0&&i!==""&&(g=yield this.getContextFile(o.context)),n.entries.push({id:o.id,prompt:o.prompt,promptHTML:yield L(o.prompt),responseText:o.responseText,context:g,created:o.created,updated:o.updated,finished:o.finished,error:o.error,chunkCount:o.chunkCount})}return n})}static \u0275fac=function(n){return new(n||t)};static \u0275prov=R({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var ve=(()=>{class t{_projectService=d(ee);_repo=d(ye);_firebase=d(k);_inProgress=y(!1);currentEntry=f(()=>{let e=this._repo.currentSession();return e?.entries[e.entries.length-1]??void 0});chatHistory=f(()=>{let e=this._repo.currentSession()?.entries;return e===void 0?[]:e.length===1?[]:e.slice(0,-1)},{equal:(e,n)=>e.length===n.length});_sessionUnsubscribe;_sessionId;destroy(){let e=this._sessionId;this._sessionUnsubscribe,this._sessionId=void 0,console.info("Unsubscribed from chat session "+e)}setSessionId(e){return u(this,null,function*(){this._sessionId=e,this._sessionUnsubscribe=this._repo.subscribeToSession(e)})}set searchTerm(e){this._sendPrompt(e)}get inProgress(){return this._inProgress}_sendPrompt(e){return u(this,null,function*(){if(this._firebase.functionAssistant===void 0)throw new Error(I.FIREBASE_NOT_INITIALIZED);this._inProgress.set(!0),this._sessionId===void 0&&(yield this.setSessionId(G()));let n={projectId:this._projectService.projectData()?.id,sessionId:this._sessionId,prompt:e};try{yield this._firebase.functionAssistant(n)}catch(o){console.error("Error calling Firebase function:",o)}this._inProgress.set(!1)})}static \u0275fac=function(n){return new(n||t)};static \u0275prov=R({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var Me=["chatContent"],Ie=(t,c)=>c.prompt;function Pe(t,c){if(t&1){let e=T();s(0,"app-info-dialog",8),w("close",function(){C(e);let o=m();return x(o.clearInfo())}),a()}if(t&2){let e=m();p("text",e.info())}}function Re(t,c){if(t&1&&l(0,"app-bot-response",10),t&2){let e=m().$implicit;p("startPassive",!0)("content",e)}}function Ee(t,c){if(t&1&&(l(0,"div",9),_(1,Re,1,2,"app-bot-response",10)),t&2){let e=c.$implicit;p("innerHTML",e.promptHTML,B),r(),h(e.responseText?1:-1)}}function Oe(t,c){if(t&1&&l(0,"app-bot-response",10),t&2){let e=m();p("startPassive",!1)("content",e)}}function ke(t,c){if(t&1&&(l(0,"div",9),_(1,Oe,1,2,"app-bot-response",10)),t&2){let e=c;p("innerHTML",e.promptHTML,B),r(),h(e.responseText?1:-1)}}var Ft=(()=>{class t{_assistant=d(ve);_state=d(te);_gtmService=d(fe);chatContent;userInput="";chatHistory=this._assistant.chatHistory;currentEntry=this._assistant.currentEntry;inProgress=this._assistant.inProgress;onCurrentResponseUpdate=M(()=>{this.currentEntry(),this.scrollToBottom()});info=y("");handleNoFilesNoSyncRights=M(()=>{let e=this._state.projectData();if(!e||e===void 0)return;e.lastSync===void 0&&!this._state.userCanSync()?this.info.set(Z.NO_FILES_NO_SYNC_RIGHTS):this.info.set("")});ngOnInit(){this._gtmService.pushTag({event:"page_view",pageName:"chat"})}ngOnDestroy(){this._assistant.destroy()}clearInfo(){this.info.set("")}sendPrompt(){this.userInput.trim()!==""&&(this._assistant.searchTerm=this.userInput.trim(),this.scrollToBottom(),this.userInput="")}scrollToBottom(){setTimeout(()=>{this.chatContent!==void 0&&(this.chatContent.nativeElement.scrollTop=this.chatContent.nativeElement.scrollHeight)},0)}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=v({type:t,selectors:[["app-chat"]],viewQuery:function(n,o){if(n&1&&j(Me,5),n&2){let i;z(i=q())&&(o.chatContent=i.first)}},decls:13,vars:3,consts:[["chatContent",""],["autosize","cdkTextareaAutosize"],[1,"chat-container"],[3,"text"],[1,"chat-content"],[1,"input-area"],["matInput","","cdkTextareaAutosize","","placeholder","Search or ask...","cdkAutosizeMinRows","1","cdkAutosizeMaxRows","5",3,"ngModelChange","keyup.enter","ngModel"],["mat-icon-button","","aria-label","Send prompt",3,"click"],[3,"close","text"],[1,"message",3,"innerHTML"],[3,"startPassive","content"]],template:function(n,o){if(n&1){let i=T();s(0,"div",2),_(1,Pe,1,1,"app-info-dialog",3),s(2,"div",4,0),E(4,Ee,2,2,null,null,Ie),_(6,ke,2,2),a(),s(7,"div",5)(8,"textarea",6,1),Q("ngModelChange",function(H){return C(i),U(o.userInput,H)||(o.userInput=H),x(H)}),w("keyup.enter",function(){return C(i),x(o.sendPrompt())}),a(),s(10,"button",7),w("click",function(){return C(i),x(o.sendPrompt())}),s(11,"mat-icon"),S(12,"start"),a()()()()}if(n&2){let i;r(),h(o.info()?1:-1),r(3),O(o.chatHistory()),r(2),h((i=o.currentEntry())?6:-1,i),r(2),$("ngModel",o.userInput)}},dependencies:[pe,se,ae,ce,xe,de,re,ie,oe,ne,F,D],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:space-between;gap:10px;height:100%;overflow:hidden}input[_ngcontent-%COMP%]{outline:none;color:var(--qaecy-font-color);border:1px solid var(--qaecy-font-color);padding:1rem;border-radius:.5rem;background-color:#0000}.chat-content[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:20px}.message[_ngcontent-%COMP%]{margin-bottom:10px}.input-area[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:row;align-items:center;gap:.5rem;justify-content:center}.input-area[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{font-size:var(--qaecy-font-size);font-family:var(--qaecy-font-family);border:none;outline:none;background-color:#0000;border:1px solid;border-radius:.3rem;padding:.5rem .5rem 2rem;overflow:hidden;width:70%;max-width:400px}"]})}return t})();export{Ft as ChatComponent};
