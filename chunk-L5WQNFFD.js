import{a as M,b as de,c as le,d as fe}from"./chunk-QZQSLQJT.js";import{c as ae,d as pe}from"./chunk-J6PENRCH.js";import"./chunk-KVOAQQQH.js";import{c as z,g as $,i as T,j as S,k as Z,o as J}from"./chunk-5SYEOOWI.js";import{a as ce}from"./chunk-EST3HM3H.js";import{a as V}from"./chunk-22TYSVVA.js";import{b as te,c as ne,e as oe,i as ie,l as re,o as se}from"./chunk-HBQL35YL.js";import"./chunk-OVK4KCAR.js";import{W as Y,X as K,Y as X,Z as ee}from"./chunk-WQ3OQIWE.js";import"./chunk-HU7WFQWJ.js";import"./chunk-4UWXHK3R.js";import{Ab as C,Fb as L,Ga as R,Gb as B,Hb as D,Ka as r,Mb as A,O as w,Qb as N,Rb as j,S as s,Sb as q,Ta as p,Ya as b,Z as y,_ as x,bb as _,bc as u,ec as v,hb as d,ja as P,jb as O,mb as g,pb as F,qb as H,rb as a,sb as m,tb as l,xb as E,zb as I}from"./chunk-SUJ2ERSS.js";import"./chunk-2MEMY2TC.js";import"./chunk-GSV7GFVO.js";import"./chunk-4JUNAGW5.js";import{Ga as Q,v as U}from"./chunk-QWYGOFBQ.js";import"./chunk-VNCJOYNM.js";import{v as G,z as W}from"./chunk-I4ID7IWF.js";import"./chunk-36JE2O54.js";import"./chunk-DAQOROHW.js";function _e(o,c){if(o&1&&l(0,"app-doc-refs",4),o&2){let e=C();d("data",e.docRefs())("highlighted",e.highlightedRef())}}var me=(()=>{class o{parsers=le;content=P.required();startPassive=P(!0);html=p("");preLoading=u(()=>{let e=this.content().responseText;return!e||e===void 0||e===""});whileLoading=u(()=>!this.content().finished);context=u(()=>this._overrideContext(this.content().context));docRefs=u(()=>{let e=this.context().refs;return e!==void 0?e:[]});highlightedRef=p("");onTextChange=v(async()=>{let e=this.content().responseText;if(e){let t=await M(e);this.startPassive()===!1&&(t=this._overridePassiveMode(t),t=this._overrideRefOutput(t)),this.html.set(t)}else this.html.set("")});_overridePassiveMode(e){return["bim-viewer","map"].forEach(t=>{e=e.replace(new RegExp(`<${t}`,"g"),`<${t} [startPassive]="false"`),e=e.replace(new RegExp(`&lt;${t}`,"g"),`&lt;${t} [startPassive]="false"`)}),e}_overrideRefOutput(e){return e=e.replace(/<ref/g,"<ref (hovered)=context.qaecyRefHoverHandler($event) (clicked)=context.qaecyRefClickHandler($event)"),e}_overrideContext(e){if(e!==void 0)return e.qaecyRefHoverHandler=t=>{let i=(t!==void 0?this._getRefFromIndex(e,t):void 0)?.documentId??"";this.highlightedRef.set(i)},e.qaecyRefClickHandler=t=>{let n=this._getRefFromIndex(e,t);console.log("Clicked ref"),console.log(n)},e}_getRefFromIndex(e,t){let n=e.refs;if(n!==void 0)return n[t]}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=b({type:o,selectors:[["app-bot-response"]],inputs:{content:[1,"content"],startPassive:[1,"startPassive"]},decls:5,vars:8,consts:[[1,"bot-response-container"],["mode","q","size","10rem"],[1,"response"],[3,"parsers","content","context"],[3,"data","highlighted"]],template:function(t,n){t&1&&(a(0,"div",0),l(1,"app-logo",1),a(2,"div",2),l(3,"ngx-dynamic-hooks",3),m(),_(4,_e,1,2,"app-doc-refs",4),m()),t&2&&(r(2),O("loader",n.preLoading())("pulse",n.whileLoading()),r(),d("parsers",n.parsers)("content",n.html())("context",n.context()),r(),g(n.docRefs().length?4:-1))},dependencies:[pe,de,fe],styles:[".bot-response-container[_ngcontent-%COMP%]{display:flex;gap:.1rem;flex-direction:column;margin-bottom:1.5rem}.response[_ngcontent-%COMP%]{background-color:var(--box-bg-color);border-radius:.5rem;padding:0 .5rem;min-height:20px}.loader[_ngcontent-%COMP%]{width:.8rem;aspect-ratio:4;background:radial-gradient(circle closest-side,#fff 90%,#0000) 0/33.3333333333% 100% space;clip-path:inset(0 100% 0 0);animation:_ngcontent-%COMP%_l1 1s steps(4) infinite}@keyframes _ngcontent-%COMP%_l1{to{clip-path:inset(0 -34% 0 0)}}.pulse[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-animation 2s infinite}@keyframes _ngcontent-%COMP%_pulse-animation{0%{box-shadow:0 0 #0003}to{box-shadow:0 0 0 20px #0000}}"]})}return o})();var ue=(()=>{class o{_firebase=s(T);_storage=this._firebase.storageChatSessions;_collection=this._firebase.collectionChatSessions;_currentSession=p(void 0);_contextStore={};get currentSession(){return this._currentSession}subscribeToSession(e){if(this._collection===void 0)throw new Error(S.FIREBASE_NOT_INITIALIZED);console.info("Subscribing to chat session "+e),this._contextStore={};let t=U(this._collection,e);return Q(t,async n=>{if(n.exists()){let i=await this._chatSessionFactory(n.data());this._currentSession.update(()=>i)}})}async getContextFile(e){if(this._storage===void 0)throw new Error(S.FIREBASE_NOT_INITIALIZED);if(this._contextStore[e]!==void 0)return this._contextStore[e];console.info(`${e} not in store. Fetching from BLOB`);let t=G(this._storage,e),i=await(await W(t)).text(),f=JSON.parse(i);return this._contextStore[e]=f,f}async _chatSessionFactory(e){let t=new z(e.id,e.projectId,e.userId);t.created=e.created,t.updated=e.updated;for(let n of e.entries){let i=n.context,f={};i!==void 0&&i!==""&&(f=await this.getContextFile(n.context)),t.entries.push({id:n.id,prompt:n.prompt,promptHTML:await M(n.prompt),responseText:n.responseText,context:f,created:n.created,updated:n.updated,finished:n.finished,error:n.error,chunkCount:n.chunkCount})}return t}static \u0275fac=function(t){return new(t||o)};static \u0275prov=w({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var he=(()=>{class o{_projectService=s(Z);_repo=s(ue);_firebase=s(T);_inProgress=p(!1);currentEntry=u(()=>{let e=this._repo.currentSession();return e?.entries[e.entries.length-1]??void 0});chatHistory=u(()=>{let e=this._repo.currentSession()?.entries;return e===void 0?[]:e.length===1?[]:e.slice(0,-1)},{equal:(e,t)=>e.length===t.length});_sessionUnsubscribe;_sessionId;destroy(){let e=this._sessionId;this._sessionUnsubscribe,this._sessionId=void 0,console.info("Unsubscribed from chat session "+e)}async setSessionId(e){this._sessionId=e,this._sessionUnsubscribe=this._repo.subscribeToSession(e)}set searchTerm(e){this._sendPrompt(e)}get inProgress(){return this._inProgress}async _sendPrompt(e){if(this._firebase.functionAssistant===void 0)throw new Error(S.FIREBASE_NOT_INITIALIZED);this._inProgress.set(!0),this._sessionId===void 0&&await this.setSessionId(V());let t={projectId:this._projectService.projectData()?.id,sessionId:this._sessionId,prompt:e};try{await this._firebase.functionAssistant(t)}catch(n){console.error("Error calling Firebase function:",n)}this._inProgress.set(!1)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=w({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var ge=["chatContent"],Ce=(o,c)=>c.prompt;function ye(o,c){if(o&1){let e=E();a(0,"app-info-dialog",8),I("close",function(){y(e);let n=C();return x(n.clearInfo())}),m()}if(o&2){let e=C();d("text",e.info())}}function xe(o,c){if(o&1&&l(0,"app-bot-response",10),o&2){let e=C().$implicit;d("startPassive",!0)("content",e)}}function ve(o,c){if(o&1&&(l(0,"div",9),_(1,xe,1,2,"app-bot-response",10)),o&2){let e=c.$implicit;d("innerHTML",e.promptHTML,R),r(),g(e.responseText?1:-1)}}function Se(o,c){if(o&1&&l(0,"app-bot-response",10),o&2){let e=C();d("startPassive",!1)("content",e)}}function we(o,c){if(o&1&&(l(0,"div",9),_(1,Se,1,2,"app-bot-response",10)),o&2){let e=c;d("innerHTML",e.promptHTML,R),r(),g(e.responseText?1:-1)}}var mt=(()=>{class o{_assistant=s(he);_state=s(J);_gtmService=s(ce);chatContent;userInput="";chatHistory=this._assistant.chatHistory;currentEntry=this._assistant.currentEntry;inProgress=this._assistant.inProgress;onCurrentResponseUpdate=v(()=>{this.currentEntry(),this._scrollToBottom()});info=p("");handleNoFilesNoSyncRights=v(()=>{let e=this._state.projectData();if(!e||e===void 0)return;e.lastSync===void 0&&!this._state.userCanSync()?this.info.set($.NO_FILES_NO_SYNC_RIGHTS):this.info.set("")});ngOnInit(){this._gtmService.pushTag({event:"page_view",pageName:"chat"})}ngOnDestroy(){this._assistant.destroy()}clearInfo(){this.info.set("")}sendPrompt(e){e.preventDefault(),this.userInput.trim()!==""&&(this._assistant.searchTerm=this.userInput.trim(),this._scrollToBottom(),this.userInput="")}_scrollToBottom(){setTimeout(()=>{this.chatContent!==void 0&&(this.chatContent.nativeElement.scrollTop=this.chatContent.nativeElement.scrollHeight)},0)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=b({type:o,selectors:[["app-chat"]],viewQuery:function(t,n){if(t&1&&L(ge,5),t&2){let i;B(i=D())&&(n.chatContent=i.first)}},decls:13,vars:3,consts:[["chatContent",""],["autosize","cdkTextareaAutosize"],[1,"chat-container"],[3,"text"],[1,"chat-content"],[1,"input-area"],["matInput","","cdkTextareaAutosize","","placeholder","Search or ask...","cdkAutosizeMinRows","1","cdkAutosizeMaxRows","5",3,"ngModelChange","keydown.enter","ngModel"],["mat-icon-button","","aria-label","Send prompt",3,"click"],[3,"close","text"],[1,"message",3,"innerHTML"],[3,"startPassive","content"]],template:function(t,n){if(t&1){let i=E();a(0,"div",2),_(1,ye,1,1,"app-info-dialog",3),a(2,"div",4,0),F(4,ve,2,2,null,null,Ce),_(6,we,2,2),m(),a(7,"div",5)(8,"textarea",6,1),q("ngModelChange",function(h){return y(i),j(n.userInput,h)||(n.userInput=h),x(h)}),I("keydown.enter",function(h){return y(i),x(n.sendPrompt(h))}),m(),a(10,"button",7),I("click",function(h){return y(i),x(n.sendPrompt(h))}),a(11,"mat-icon"),A(12,"start"),m()()()()}if(t&2){let i;r(),g(n.info()?1:-1),r(3),H(n.chatHistory()),r(2),g((i=n.currentEntry())?6:-1,i),r(2),N("ngModel",n.userInput)}},dependencies:[se,oe,ie,re,me,ae,ne,te,K,Y,ee,X],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:space-between;gap:10px;height:100%;overflow:hidden}.chat-content[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:20px}.message[_ngcontent-%COMP%]{margin-bottom:10px}.input-area[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:row;align-items:center;gap:.5rem;justify-content:center}.input-area[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{font-size:var(--qaecy-font-size);font-family:var(--qaecy-font-family);border:1px solid;border-radius:.3rem;border-color:var(--qaecy-font-color);color:var(--qaecy-font-color);outline:none;background-color:#0000;padding:.5rem .5rem 2rem;overflow:hidden;width:70%;max-width:400px}"]})}return o})();export{mt as ChatComponent};
