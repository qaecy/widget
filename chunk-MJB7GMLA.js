import{a as j,b,c as E}from"./chunk-7PHHNNQE.js";import{g as _,h as y,k as g}from"./chunk-7SQ3PTZY.js";import{O as f,S as c,Ta as p,ac as d,bc as l}from"./chunk-6VJMAFGR.js";import{m as S,v as I,x as D}from"./chunk-SXCIL3LG.js";import{O as m}from"./chunk-I7PEP2DU.js";import{a as u,h as a}from"./chunk-TJICSKBO.js";var v=(()=>{class e{_storage;constructor(){this._storage=D(m())}uploadData(n,t){return a(this,null,function*(){let o=yield this._getDocumentUUID(n.buffer),s=I(this._storage,`${t.space_id}/${o}${t.suffix}`);yield S(s,n,{customMetadata:u({},t)})})}_getDocumentUUID(n){return a(this,null,function*(){let t=yield E(n);return j(t)})}static \u0275fac=function(t){return new(t||e)};static \u0275prov=f({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();var h=function(e){return e.MISSING_CONFIG='"Please provide config using init() method!"',e.MISSING_PROJECT_DATA="Project data is not available",e.MISSING_PROJECT_ID='No project id is defined. Please specify using the "pid" attribute',e.MISSING_USER_ID="User id is not available.",e.ORG_NO_ADMINS_SELECTED="An organization must have at least one admin",e.ORG_NO_MEMBERS_SELECTED="An organization must have at least one member",e.PROJ_NO_ADMINS_SELECTED="A project must have at least one admin",e.PROJ_NO_MEMBERS_SELECTED="A project must have at least one member",e}(h||{});var q=(()=>{class e{_options=c(g);_storage=c(v);_auth=c(_);_proj=c(y);_hostList=p([]);hostListEnriched=d(()=>{let n=this._options.options().hostApp;return this._hostList().map(t=>Object.assign({fileUUID:b(t.relativePath,n)},t))});hostSyncObject=d(()=>{if(!this.hostListEnriched().length)return;let n={};return this.hostListEnriched().forEach(t=>{n[t.fileUUID]=t.modified}),n});serverSyncObject=d(()=>this._proj.projectData()?.syncDetails);syncTable=d(()=>{if(this.hostSyncObject()===void 0)return[];let t=this.serverSyncObject()??{};return this.hostListEnriched().map(o=>{let s=t[o.fileUUID],r=s!==void 0,i=!r||new Date(o.modified)>new Date(s);return Object.assign({synced:r,outdated:i,lastSync:s},o)})});_pendingFileSync=l(()=>{let n=this.syncTable();if(!n.length)return!1;let t=n.filter(o=>o.outdated);return t.length===0&&console.info(`Received ${n.length} files from host but all of them were up to date`),t.length>0});_syncPct=p(0);_syncDone=p(!1);get syncPct(){return this._syncPct}get syncDone(){return this._syncDone}set hostList(n){this._hostList.update(()=>[...n])}get hostList(){return this._hostList}get pendingFileSync(){return this._pendingFileSync}dismissPendingFileSync(){this._pendingFileSync.set(!1)}sync(n){return a(this,null,function*(){let t=this._proj.projectData();if(!t||t===void 0)throw new Error(h.MISSING_PROJECT_DATA);let o=t.id;if(o===void 0)throw new Error(h.MISSING_PROJECT_ID);let s=this._auth.user()?.uid;if(s===void 0)throw new Error(h.MISSING_USER_ID);let r=0;for(let i of n){let U=i.name.split(".").pop()??"",O={uploaded_by:s,suffix:`.${U}`,space_id:o,name:i.relativePath,last_seen_as:JSON.stringify({host:this._options.options().hostApp,fileUUID:i.fileUUID}),additional_metadata:JSON.stringify({name:i.name,created:i.created,createdBy:i.createdBy,modified:i.modified,modifiedBy:i.modifiedBy})},N=yield i.data(i.iri);yield this._storage.uploadData(N,O),r++,this._syncPct.set(Math.round(r/n.length*100))}this._syncDone.set(!0),this._pendingFileSync.set(!1),this._hostList.set([])})}static \u0275fac=function(t){return new(t||e)};static \u0275prov=f({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();export{h as a,q as b};
