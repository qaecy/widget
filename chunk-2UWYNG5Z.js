import{a as D,b as I,c as j}from"./chunk-A2LSBBSI.js";import{k as l,r as _,s as a,t as g,w as S}from"./chunk-R3QQGGC6.js";import{O as f,S as r,Ta as h,dc as c,ec as u}from"./chunk-I7ZHWVYA.js";import{m,v as y}from"./chunk-I4ID7IWF.js";import{a as p}from"./chunk-DAQOROHW.js";var b=(()=>{class s{_firebase=r(_);_storage=this._firebase.storageRaw;async uploadData(e,t){if(this._storage===void 0)throw new Error(a.FIREBASE_NOT_INITIALIZED);let n=await this._getDocumentUUID(e.buffer),o=y(this._storage,`${t.space_id}/${n}${t.suffix}`);await m(o,e,{customMetadata:p({},t)})}async _getDocumentUUID(e){let t=await j(e);return D(t)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var z=(()=>{class s{_options=r(S);_storage=r(b);_auth=r(l);_proj=r(g);_hostList=h([]);hostListEnriched=c(()=>{let e=this._options.options().hostApp;return this._hostList().map(t=>Object.assign({fileUUID:I(t.relativePath,e)},t))});hostSyncObject=c(()=>{if(!this.hostListEnriched().length)return;let e={};return this.hostListEnriched().forEach(t=>{e[t.fileUUID]=t.modified}),e});serverSyncObject=c(()=>this._proj.projectData()?.syncDetails);syncCount=c(()=>{let e=this._proj.projectData();if(e?.syncDetails===void 0)return 0;let t=new Set;return Object.values(e?.syncDetails).forEach(n=>t.add(n)),t.size});syncTable=c(()=>{if(this.hostSyncObject()===void 0)return[];let t=this.serverSyncObject()??{};return this.hostListEnriched().map(n=>{let o=t[n.fileUUID],d=o!==void 0,i=!d||new Date(n.modified)>new Date(o);return Object.assign({synced:d,outdated:i,lastSync:o},n)})});_pendingFileSync=u(()=>{let e=this.syncTable();if(!e.length)return!1;let t=e.filter(n=>n.outdated);return t.length===0&&console.info(`Received ${e.length} files from host but all of them were up to date`),t.length>0});_syncPct=h(0);_syncDone=h(!1);get syncPct(){return this._syncPct}get syncDone(){return this._syncDone}set hostList(e){this._hostList.update(()=>[...e])}get hostList(){return this._hostList}get pendingFileSync(){return this._pendingFileSync}dismissPendingFileSync(){this._pendingFileSync.set(!1)}async sync(e){let t=this._proj.projectData();if(!t||t===void 0)throw new Error(a.MISSING_PROJECT_DATA);let n=t.id;if(n===void 0)throw new Error(a.MISSING_PROJECT_ID);let o=this._auth.user()?.uid;if(o===void 0)throw new Error(a.MISSING_USER_ID);let d=0;for(let i of e){let w=i.name.split(".").pop()??"",U={uploaded_by:o,suffix:`.${w}`,space_id:n,name:i.relativePath,last_seen_as:JSON.stringify({host:this._options.options().hostApp,fileUUID:i.fileUUID}),additional_metadata:JSON.stringify({name:i.name,created:i.created,createdBy:i.createdBy,modified:i.modified,modifiedBy:i.modifiedBy})},E=await i.data(i.iri);await this._storage.uploadData(E,U),d++,this._syncPct.set(Math.round(d/e.length*100))}this._syncDone.set(!0),this._pendingFileSync.set(!1),this._hostList.set([])}static \u0275fac=function(t){return new(t||s)};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();export{z as a};
