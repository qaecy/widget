import{a as F,b as ue,c as _e}from"./chunk-X2IKJ4UM.js";import{c as me,d as fe}from"./chunk-J6PENRCH.js";import"./chunk-KVOAQQQH.js";import{c as G,g as W,i as O,j as M,k as X,o as ee}from"./chunk-5SZPNJNH.js";import{a as de}from"./chunk-EST3HM3H.js";import{a as Q}from"./chunk-22TYSVVA.js";import{b as oe,c as ie,e as re,i as se,l as ae,o as ce}from"./chunk-HBQL35YL.js";import{p as pe,q as le}from"./chunk-OVK4KCAR.js";import{W as te,X as ne,Y as k,Z as D}from"./chunk-WQ3OQIWE.js";import"./chunk-HU7WFQWJ.js";import"./chunk-4UWXHK3R.js";import{Ab as m,Fb as N,Ga as H,Gb as j,Hb as z,Ka as r,Mb as b,Nb as B,O as P,Qb as q,Rb as $,S as d,Sb as U,Ta as x,Ya as y,Z as g,_ as C,bb as u,bc as f,ec as T,hb as p,ja as v,jb as V,mb as _,nb as A,pb as R,qb as E,rb as s,sb as a,tb as l,xb as w,zb as S}from"./chunk-SUJ2ERSS.js";import"./chunk-2MEMY2TC.js";import"./chunk-GSV7GFVO.js";import"./chunk-4JUNAGW5.js";import{Ga as J,v as Z}from"./chunk-QWYGOFBQ.js";import"./chunk-VNCJOYNM.js";import{v as Y,z as K}from"./chunk-I4ID7IWF.js";import"./chunk-36JE2O54.js";import"./chunk-DAQOROHW.js";function ve(t,c){if(t&1){let e=w();s(0,"div",1),S("mouseover",function(){g(e);let o=m();return C(o.onHover())})("mouseout",function(){g(e);let o=m();return C(o.onLeave())}),s(1,"span",2),b(2),a(),s(3,"span",3),b(4),a()()}if(t&2){let e=c,n=m();p("matTooltip",e.text),r(2),B(n.textShort()),r(2),B(e.label)}}var he=(()=>{class t{data=v();textShort=f(()=>this.data()?.text?.substring(0,20)+"...");onHover(){console.log("H")}onLeave(){console.log("L")}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=y({type:t,selectors:[["app-doc-ref"]],inputs:{data:[1,"data"]},decls:1,vars:1,consts:[[1,"box",3,"matTooltip"],[1,"box",3,"mouseover","mouseout","matTooltip"],[1,"text"],[1,"label"]],template:function(n,o){if(n&1&&u(0,ve,5,3,"div",0),n&2){let i;_((i=o.data())?0:-1,i)}},dependencies:[le,pe],styles:[".box[_ngcontent-%COMP%]{font-size:.5rem;border-radius:.3rem;outline-color:var(--mat-sys-outline);display:flex;flex-direction:column;max-width:4rem;padding:.3rem;background-color:var(--box-bg-color);height:100%}.box[_ngcontent-%COMP%]:hover{background-color:var(--mat-sys-secondary-container)}.label[_ngcontent-%COMP%]{font-weight:700}.text[_ngcontent-%COMP%]{font-weight:400}"]})}return t})();function Se(t,c){if(t&1&&l(0,"app-doc-ref",2),t&2){let e=c.$implicit;p("data",e)}}var ge=(()=>{class t{data=v([]);static \u0275fac=function(n){return new(n||t)};static \u0275cmp=y({type:t,selectors:[["app-doc-refs"]],inputs:{data:[1,"data"]},decls:5,vars:0,consts:[[1,"ref-container"],[1,"quote"],[3,"data"]],template:function(n,o){n&1&&(s(0,"div",0)(1,"mat-icon",1),b(2,"format_quote"),a(),R(3,Se,1,1,"app-doc-ref",2,A),a()),n&2&&(r(3),E(o.data()))},dependencies:[he,D,k],styles:[".ref-container[_ngcontent-%COMP%]{padding:.6rem .2rem;position:relative;display:flex;flex-direction:row;gap:.5rem;overflow-y:auto}.quote[_ngcontent-%COMP%]{position:absolute;left:-2px;top:-2px}"]})}return t})();function we(t,c){if(t&1&&l(0,"app-doc-refs",4),t&2){let e=m();p("data",e.docRefs())}}var Ce=(()=>{class t{parsers=_e;content=v.required();startPassive=v(!0);html=x("");preLoading=f(()=>{let e=this.content().responseText;return!e||e===void 0||e===""});whileLoading=f(()=>!this.content().finished);context=f(()=>this.content().context);docRefs=f(()=>{let e=this.context().refs;return e!==void 0?e:[]});onTextChange=T(async()=>{let e=this.content().responseText;if(e){let n=await F(e);this.startPassive()===!1&&(n=this._overridePassiveMode(n)),this.html.set(n)}else this.html.set("")});_overridePassiveMode(e){return["bim-viewer","map"].forEach(n=>{e=e.replace(`<${n}`,`<${n} [startPassive]="false"`),e=e.replace(`&lt;${n}`,`&lt;${n} [startPassive]="false"`)}),e}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=y({type:t,selectors:[["app-bot-response"]],inputs:{content:[1,"content"],startPassive:[1,"startPassive"]},decls:5,vars:8,consts:[[1,"bot-response-container"],["mode","q","size","10rem"],[1,"response"],[3,"parsers","content","context"],[3,"data"]],template:function(n,o){n&1&&(s(0,"div",0),l(1,"app-logo",1),s(2,"div",2),l(3,"ngx-dynamic-hooks",3),a(),u(4,we,1,1,"app-doc-refs",4),a()),n&2&&(r(2),V("loader",o.preLoading())("pulse",o.whileLoading()),r(),p("parsers",o.parsers)("content",o.html())("context",o.context()),r(),_(o.docRefs()?4:-1))},dependencies:[fe,ue,ge],styles:[".bot-response-container[_ngcontent-%COMP%]{display:flex;gap:.1rem;flex-direction:column;margin-bottom:1.5rem}.response[_ngcontent-%COMP%]{background-color:var(--box-bg-color);border-radius:.5rem;padding:0 .5rem;min-height:20px}.loader[_ngcontent-%COMP%]{width:.8rem;aspect-ratio:4;background:radial-gradient(circle closest-side,#fff 90%,#0000) 0/33.3333333333% 100% space;clip-path:inset(0 100% 0 0);animation:_ngcontent-%COMP%_l1 1s steps(4) infinite}@keyframes _ngcontent-%COMP%_l1{to{clip-path:inset(0 -34% 0 0)}}.pulse[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-animation 2s infinite}@keyframes _ngcontent-%COMP%_pulse-animation{0%{box-shadow:0 0 #0003}to{box-shadow:0 0 0 20px #0000}}"]})}return t})();var xe=(()=>{class t{_firebase=d(O);_storage=this._firebase.storageChatSessions;_collection=this._firebase.collectionChatSessions;_currentSession=x(void 0);_contextStore={};get currentSession(){return this._currentSession}subscribeToSession(e){if(this._collection===void 0)throw new Error(M.FIREBASE_NOT_INITIALIZED);console.info("Subscribing to chat session "+e),this._contextStore={};let n=Z(this._collection,e);return J(n,async o=>{if(o.exists()){let i=await this._chatSessionFactory(o.data());this._currentSession.update(()=>i)}})}async getContextFile(e){if(this._storage===void 0)throw new Error(M.FIREBASE_NOT_INITIALIZED);if(this._contextStore[e]!==void 0)return this._contextStore[e];console.info(`${e} not in store. Fetching from BLOB`);let n=Y(this._storage,e),i=await(await K(n)).text(),h=JSON.parse(i);return this._contextStore[e]=h,h}async _chatSessionFactory(e){let n=new G(e.id,e.projectId,e.userId);n.created=e.created,n.updated=e.updated;for(let o of e.entries){let i=o.context,h={};i!==void 0&&i!==""&&(h=await this.getContextFile(o.context)),n.entries.push({id:o.id,prompt:o.prompt,promptHTML:await F(o.prompt),responseText:o.responseText,context:h,created:o.created,updated:o.updated,finished:o.finished,error:o.error,chunkCount:o.chunkCount})}return n}static \u0275fac=function(n){return new(n||t)};static \u0275prov=P({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var ye=(()=>{class t{_projectService=d(X);_repo=d(xe);_firebase=d(O);_inProgress=x(!1);currentEntry=f(()=>{let e=this._repo.currentSession();return e?.entries[e.entries.length-1]??void 0});chatHistory=f(()=>{let e=this._repo.currentSession()?.entries;return e===void 0?[]:e.length===1?[]:e.slice(0,-1)},{equal:(e,n)=>e.length===n.length});_sessionUnsubscribe;_sessionId;destroy(){let e=this._sessionId;this._sessionUnsubscribe,this._sessionId=void 0,console.info("Unsubscribed from chat session "+e)}async setSessionId(e){this._sessionId=e,this._sessionUnsubscribe=this._repo.subscribeToSession(e)}set searchTerm(e){this._sendPrompt(e)}get inProgress(){return this._inProgress}async _sendPrompt(e){if(this._firebase.functionAssistant===void 0)throw new Error(M.FIREBASE_NOT_INITIALIZED);this._inProgress.set(!0),this._sessionId===void 0&&await this.setSessionId(Q());let n={projectId:this._projectService.projectData()?.id,sessionId:this._sessionId,prompt:e};try{await this._firebase.functionAssistant(n)}catch(o){console.error("Error calling Firebase function:",o)}this._inProgress.set(!1)}static \u0275fac=function(n){return new(n||t)};static \u0275prov=P({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var Te=["chatContent"],Me=(t,c)=>c.prompt;function Ie(t,c){if(t&1){let e=w();s(0,"app-info-dialog",8),S("close",function(){g(e);let o=m();return C(o.clearInfo())}),a()}if(t&2){let e=m();p("text",e.info())}}function Pe(t,c){if(t&1&&l(0,"app-bot-response",10),t&2){let e=m().$implicit;p("startPassive",!0)("content",e)}}function Re(t,c){if(t&1&&(l(0,"div",9),u(1,Pe,1,2,"app-bot-response",10)),t&2){let e=c.$implicit;p("innerHTML",e.promptHTML,H),r(),_(e.responseText?1:-1)}}function Ee(t,c){if(t&1&&l(0,"app-bot-response",10),t&2){let e=m();p("startPassive",!1)("content",e)}}function Oe(t,c){if(t&1&&(l(0,"div",9),u(1,Ee,1,2,"app-bot-response",10)),t&2){let e=c;p("innerHTML",e.promptHTML,H),r(),_(e.responseText?1:-1)}}var Et=(()=>{class t{_assistant=d(ye);_state=d(ee);_gtmService=d(de);chatContent;userInput="";chatHistory=this._assistant.chatHistory;currentEntry=this._assistant.currentEntry;inProgress=this._assistant.inProgress;onCurrentResponseUpdate=T(()=>{this.currentEntry(),this.scrollToBottom()});info=x("");handleNoFilesNoSyncRights=T(()=>{let e=this._state.projectData();if(!e||e===void 0)return;e.lastSync===void 0&&!this._state.userCanSync()?this.info.set(W.NO_FILES_NO_SYNC_RIGHTS):this.info.set("")});ngOnInit(){this._gtmService.pushTag({event:"page_view",pageName:"chat"})}ngOnDestroy(){this._assistant.destroy()}clearInfo(){this.info.set("")}sendPrompt(){this.userInput.trim()!==""&&(this._assistant.searchTerm=this.userInput.trim(),this.scrollToBottom(),this.userInput="")}scrollToBottom(){setTimeout(()=>{this.chatContent!==void 0&&(this.chatContent.nativeElement.scrollTop=this.chatContent.nativeElement.scrollHeight)},0)}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=y({type:t,selectors:[["app-chat"]],viewQuery:function(n,o){if(n&1&&N(Te,5),n&2){let i;j(i=z())&&(o.chatContent=i.first)}},decls:13,vars:3,consts:[["chatContent",""],["autosize","cdkTextareaAutosize"],[1,"chat-container"],[3,"text"],[1,"chat-content"],[1,"input-area"],["matInput","","cdkTextareaAutosize","","placeholder","Search or ask...","cdkAutosizeMinRows","1","cdkAutosizeMaxRows","5",3,"ngModelChange","keyup.enter","ngModel"],["mat-icon-button","","aria-label","Send prompt",3,"click"],[3,"close","text"],[1,"message",3,"innerHTML"],[3,"startPassive","content"]],template:function(n,o){if(n&1){let i=w();s(0,"div",2),u(1,Ie,1,1,"app-info-dialog",3),s(2,"div",4,0),R(4,Re,2,2,null,null,Me),u(6,Oe,2,2),a(),s(7,"div",5)(8,"textarea",6,1),U("ngModelChange",function(L){return g(i),$(o.userInput,L)||(o.userInput=L),C(L)}),S("keyup.enter",function(){return g(i),C(o.sendPrompt())}),a(),s(10,"button",7),S("click",function(){return g(i),C(o.sendPrompt())}),s(11,"mat-icon"),b(12,"start"),a()()()()}if(n&2){let i;r(),_(o.info()?1:-1),r(3),E(o.chatHistory()),r(2),_((i=o.currentEntry())?6:-1,i),r(2),q("ngModel",o.userInput)}},dependencies:[ce,re,se,ae,Ce,me,ie,oe,ne,te,D,k],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:space-between;gap:10px;height:100%;overflow:hidden}input[_ngcontent-%COMP%]{outline:none;color:var(--qaecy-font-color);border:1px solid var(--qaecy-font-color);padding:1rem;border-radius:.5rem;background-color:#0000}.chat-content[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:20px}.message[_ngcontent-%COMP%]{margin-bottom:10px}.input-area[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:row;align-items:center;gap:.5rem;justify-content:center}.input-area[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{font-size:var(--qaecy-font-size);font-family:var(--qaecy-font-family);border:none;outline:none;background-color:#0000;border:1px solid;border-radius:.3rem;padding:.5rem .5rem 2rem;overflow:hidden;width:70%;max-width:400px}"]})}return t})();export{Et as ChatComponent};
