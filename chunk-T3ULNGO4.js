import{a as R,b as Me,c as Oe,d as Pe}from"./chunk-VCHDHGYJ.js";import{b as ce,e as D}from"./chunk-NYCDMEH7.js";import"./chunk-KVOAQQQH.js";import{c as de,d as pe,e as V,j as N,k as fe,l as he,m as _e,n as ge,o as be,r as M,s as b,t as ye,v as we,y as xe}from"./chunk-R3QQGGC6.js";import{a as Ee}from"./chunk-ED775GB7.js";import{a as le}from"./chunk-22TYSVVA.js";import{b as L,d as Se,h as Ie,k as Te,n as H}from"./chunk-3SWDVHZZ.js";import{g as se,h as A,i as ae,j as B}from"./chunk-X2FZSAPJ.js";import"./chunk-YLLDSACH.js";import{g as ie,j as re}from"./chunk-7DTGGGFL.js";import{Ab as g,Fb as J,Ga as j,Gb as Y,Hb as Z,Jb as K,Ka as s,Kb as X,Mb as ee,O as I,Qb as te,Rb as ne,S as c,Sb as oe,Ta as l,Ua as U,Ya as T,Z as w,_ as x,bb as v,dc as _,gc as y,hb as d,ib as z,ja as P,jb as G,mb as m,pb as Q,qb as W,rb as f,sb as u,tb as h,xb as E,zb as S}from"./chunk-I7ZHWVYA.js";import"./chunk-2MEMY2TC.js";import"./chunk-GSV7GFVO.js";import"./chunk-4JUNAGW5.js";import{Ca as me,Ga as ue,v as $}from"./chunk-QWYGOFBQ.js";import"./chunk-VNCJOYNM.js";import{v as Ce,z as ve}from"./chunk-I4ID7IWF.js";import"./chunk-36JE2O54.js";import{a as O}from"./chunk-DAQOROHW.js";function Le(o,p){if(o&1&&(f(0,"div",4),h(1,"ngx-dynamic-hooks",5),u()),o&2){let e=g();G("pulse",e.whileLoading()),s(),d("parsers",e.parsers)("content",e.html())("context",e.context())}}var Re=(()=>{class o{parsers=Oe;content=P.required();startPassive=P(!0);html=l("");preLoading=_(()=>{let e=this.content().responseText;return!e||e===void 0||e===""});whileLoading=_(()=>!this.content().finished);context=_(()=>this._overrideContext(this.content().context));highlightedRef=l("");onTextChange=y(async()=>{let e=this.content().responseText;if(e){let t=await R(e);this.startPassive()===!1&&(t=this._overridePassiveMode(t),t=this._overrideRefOutput(t)),this.html.set(t)}else this.html.set("")});_overridePassiveMode(e){return["bim-viewer","map"].forEach(t=>{e=e.replace(new RegExp(`<${t}`,"g"),`<${t} [startPassive]="false"`),e=e.replace(new RegExp(`&lt;${t}`,"g"),`&lt;${t} [startPassive]="false"`)}),e}_overrideRefOutput(e){let t=/<ref\b[^>]*>.*?<\/ref>/g;return e.match(t)?.forEach(i=>{let r=i.match(/\bi=["']?([^"'\s>]+)["']?/);if(r){let a=parseInt(r[1]),C="(hovered)=context.qaecyRefHoverHandler($event) (clicked)=context.qaecyRefClickHandler($event)";this.context().refs!==void 0&&(C+=` [data]="context.refs[${a}]"`);let q=i.replace("<ref",`<ref ${C}`);e=e.replace(i,q)}}),e}_overrideContext(e){if(e!==void 0){if(e.qaecyRefHoverHandler=t=>{let i=(t!==void 0?this._getRefFromIndex(e,t):void 0)?.documentId??"";this.highlightedRef.set(i)},e.qaecyRefClickHandler=t=>{let n=this._getRefFromIndex(e,t);console.log("Clicked ref"),console.log(n)},e.refs!==void 0){let t=Object.assign({},e.documents);e.refs.forEach(n=>{n.documentData=t[n.documentId]??void 0})}return e}}_getRefFromIndex(e,t){let n=e.refs;if(n!==void 0)return n[t]}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=T({type:o,selectors:[["app-bot-response"]],inputs:{content:[1,"content"],startPassive:[1,"startPassive"]},decls:5,vars:3,consts:[[1,"bot-response-container"],[1,"q"],["mode","q","size","10rem"],[1,"response",3,"pulse"],[1,"response"],[3,"parsers","content","context"]],template:function(t,n){t&1&&(f(0,"div",0)(1,"div",1),h(2,"lib-logo",2)(3,"div"),u(),v(4,Le,2,5,"div",3),u()),t&2&&(s(3),G("loader",n.preLoading()),s(),m(n.preLoading()?-1:4))},dependencies:[ce,Me],styles:[".bot-response-container[_ngcontent-%COMP%]{display:flex;gap:.1rem;flex-direction:column;margin-bottom:1.5rem}.q[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:5px}.response[_ngcontent-%COMP%]{background-color:var(--box-bg-color);border-radius:.5rem;line-height:calc(var(--qaecy-font-size) * 1.9);font-weight:300;padding:0 .5rem;min-height:20px;transition:1s ease-in}.loader[_ngcontent-%COMP%]{width:.8rem;aspect-ratio:4;background:radial-gradient(circle closest-side,var(--qaecy-font-color) 90%,rgba(0,0,0,0)) 0/33.3333333333% 100% space;clip-path:inset(0 100% 0 0);animation:_ngcontent-%COMP%_l1 1s steps(4) infinite}@keyframes _ngcontent-%COMP%_l1{to{clip-path:inset(0 -34% 0 0)}}.pulse[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-animation 2s infinite}@keyframes _ngcontent-%COMP%_pulse-animation{0%{box-shadow:0 0 #0003}to{box-shadow:0 0 0 20px #0000}}"]})}return o})();var ke=(()=>{class o{_firebase=c(M);_storage=this._firebase.storageChatSessions;_collection=this._firebase.collectionChatSessions;_currentSession=l(void 0);_contextStore={};get currentSession(){return this._currentSession}subscribeToSession(e){if(this._collection===void 0)throw new Error(b.FIREBASE_NOT_INITIALIZED);console.info("Subscribing to chat session "+e),this._contextStore={};let t=$(this._collection,e);return ue(t,async n=>{if(n.exists()){let i=await this._chatSessionFactory(n.data());this._currentSession.update(()=>i)}})}async getContextFile(e){if(this._storage===void 0)throw new Error(b.FIREBASE_NOT_INITIALIZED);if(this._contextStore[e]!==void 0)return this._contextStore[e];console.info(`${e} not in store. Fetching from BLOB`);let t=Ce(this._storage,e),i=await(await ve(t)).text(),r=JSON.parse(i);return this._contextStore[e]=r,r}async createChatSessionIfNotExists(e,t,n,i){if(this._collection===void 0)throw new Error(b.FIREBASE_NOT_INITIALIZED);console.info(N.CREATING_CHAT_SESSION+` ${e}`);let r=new de(e,t,n),a=Object.assign({entries:[]},r),C=Object.assign({entries:[]},r);i!==void 0&&(C.entries=[new V(i)]),this._currentSession.update(()=>C);let q=$(this._collection,a.id);try{await me(q,O({},a)),console.info(`Chat session ${e} created`)}catch(Ne){console.warn(Ne)}}async addTempChatEntry(e){let t=this._currentSession();if(t===void 0)throw new Error("No current chat session");let n=new V(e);n.promptHTML=await R(e),t.entries.push(n),this._currentSession.update(()=>Object.assign({},t))}async _chatSessionFactory(e){let t=new pe(e.id,e.projectId,e.userId);t.created=e.created,t.updated=e.updated;for(let n of e.entries){let i=n.context,r={};i!==void 0&&i!==""&&(r=await this.getContextFile(n.context)),t.entries.push({id:n.id,prompt:n.prompt,promptHTML:await R(n.prompt),responseText:n.responseText,context:r,created:n.created,updated:n.updated,finished:n.finished,error:n.error,chunkCount:n.chunkCount})}return t}static \u0275fac=function(t){return new(t||o)};static \u0275prov=I({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var Ae=(()=>{class o{_auth=c(fe);_firebase=c(M);_baseURL=_(()=>this._firebase.usingEmulators()?_e:he);_token=this._auth.token;async sendAuthenticatedRequest(e,t,n,i={}){let r={"Content-Type":"application/json"};if(this._token()===void 0)throw new Error("Token not available");r.Authorization=`Bearer ${this._token()}`,i.method=t,i.headers=i.headers===void 0?r:O(O({},i.headers),r),n!==void 0&&(i.body=JSON.stringify(n)),t!=="POST"&&delete i.body;let a=`${this._baseURL()}/${e}`,C=await fetch(a,i);if(!C.ok)throw new Error(`HTTP error! status: ${C.status}`);return C}pingRoute=async(e,t=5e3)=>{let n=`${this._baseURL()}/${e}`;try{let i=new AbortController,r=setTimeout(()=>i.abort(),t);if(this._token()===void 0)throw new Error("Token not available");let a={Authorization:`Bearer ${this._token()}`};return await fetch(n,{signal:i.signal,headers:a}),clearTimeout(r),!0}catch(i){return i.name==="AbortError"?console.error("Request timed out"):console.error("Server is offline or unreachable"),!1}};static \u0275fac=function(t){return new(t||o)};static \u0275prov=I({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var F=(()=>{class o{_projectService=c(ye);_userService=c(we);_repo=c(ke);_firebase=c(M);_gateway=c(Ae);_inProgress=l(!1);currentEntry=_(()=>{let e=this._repo.currentSession();return e?.entries[e.entries.length-1]??void 0});chatHistory=_(()=>{let e=this._repo.currentSession()?.entries;return e===void 0?[]:e.length===1?[]:e.slice(0,-1)},{equal:(e,t)=>e.length===t.length});_available=l(void 0);pingServerWhenUserAvailable=y(async()=>{if(this._firebase.ready()){let t=await this._gateway.pingRoute(be);console.warn("Replace with a ping URL that accepts get request"),this._available.set(t)}});_projectId=_(()=>this._projectService.projectData()?.id);_userId=_(()=>this._userService.userData()?.id);_sessionUnsubscribe;_sessionId;destroy(){let e=this._sessionId;this._sessionUnsubscribe,this._sessionId=void 0,console.info("Unsubscribed from chat session "+e)}constructor(){console.warn("OVERRIDING CHAT SESSION!!")}get inProgress(){return this._inProgress}get sessionId(){return this._sessionId}get available(){return this._available}async setSessionId(e,t){this._sessionId=e;let n=this._projectId(),i=this._userId();if(n===void 0)throw new Error(b.MISSING_PROJECT_ID);if(i===void 0)throw new Error(b.MISSING_USER_ID);await this._repo.createChatSessionIfNotExists(e,n,i,t),this._sessionUnsubscribe=this._repo.subscribeToSession(e)}async sendPrompt(e){this._inProgress.set(!0),this._sessionId===void 0&&await this.setSessionId(le(),e);let t={spaceId:this._projectId(),id:this._sessionId,userId:this._userId(),prompt:e};try{await this._gateway.sendAuthenticatedRequest(ge,"POST",t)}catch(n){throw console.error("Error calling Firebase function:",n),new Error(b.AGENT_API_NOT_CALLABLE)}this._inProgress.set(!1)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=I({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var He=["textarea"];function De(o,p){if(o&1){let e=E();f(0,"app-info-dialog",7),S("close",function(){w(e);let n=g();return x(n.clearError())}),u()}if(o&2){let e=g();d("text",e.error())}}var Be=(()=>{class o{_assistant=c(F);hidden=P(!1);userInput="";showHideClass=l("");_textarea=U("textarea");error=l("");animateOnHiddenToggled=y(()=>{this.hidden()?this.showHideClass.set("hide"):this.showHideClass.set("show")});ngAfterViewInit(){this._textarea()?.nativeElement.addEventListener("input",e=>{let t=e.target;t.style.height="auto",t.style.height=t.scrollHeight+"px"})}sendPrompt(e){if(e.preventDefault(),this.userInput.trim()!==""){try{this._assistant.sendPrompt(this.userInput.trim())}catch(n){console.error(n),this.error.set(n)}this.userInput="";let t=this._textarea()?.nativeElement;t.style.height="auto"}}clearError(){this.error.set("")}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=T({type:o,selectors:[["app-search-bar"]],viewQuery:function(t,n){t&1&&K(n._textarea,He,5),t&2&&X()},inputs:{hidden:[1,"hidden"]},decls:9,vars:6,consts:[["textarea",""],[3,"text"],[1,"search-bar-container",3,"ngClass"],[1,"search-bar-inner-container"],[1,"input-area"],["matInput","","placeholder","Search or ask...","rows","1",3,"ngModelChange","keydown.enter","ngModel"],["mat-icon-button","","aria-label","Send prompt",3,"click","disabled"],[3,"close","text"]],template:function(t,n){if(t&1){let i=E();v(0,De,1,1,"app-info-dialog",1),f(1,"div",2)(2,"div",3)(3,"div",4)(4,"textarea",5,0),oe("ngModelChange",function(a){return w(i),ne(n.userInput,a)||(n.userInput=a),x(a)}),S("keydown.enter",function(a){return w(i),x(n.sendPrompt(a))}),u(),f(6,"button",6),S("click",function(a){return w(i),x(n.sendPrompt(a))}),f(7,"mat-icon"),ee(8,"start"),u()()()()()}t&2&&(m(n.error()?0:-1),s(),d("ngClass",n.showHideClass()),s(),z("border",n.userInput?"none":"0.01rem solid var(--qaecy-font-color)"),s(2),te("ngModel",n.userInput),s(2),d("disabled",!n.userInput))},dependencies:[re,ie,H,Se,Ie,Te,L,B,ae,A,se,D],styles:[".search-bar-container[_ngcontent-%COMP%]{position:absolute;bottom:0;left:0;right:0;width:100%;display:flex;flex-direction:row;justify-content:center;transition:opacity .3s ease-in-out}.search-bar-inner-container[_ngcontent-%COMP%]{-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(6px);box-shadow:var(--frosted-shadow);border-radius:1rem;width:80%;max-width:400px;padding:calc(var(--qaecy-font-size) * .2)}.input-area[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center;gap:.5rem;justify-content:center}.input-area[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{font-size:var(--qaecy-font-size);font-family:var(--qaecy-font-family);border:1px solid;border-radius:.3rem;border-color:#0000;color:var(--qaecy-font-color);outline:none;background-color:#0000;padding:.5rem;width:85%;max-width:800px;max-height:calc(var(--qaecy-font-size) * 10);scrollbar-width:none;scrollbar-gutter:stable;transition:height .3s ease;resize:none}textarea[_ngcontent-%COMP%]:-webkit-scrollbar{display:none}.search-bar-container.show[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_bounceIn .6s ease-out forwards}.search-bar-container.hide[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_bounceOut .6s ease-in forwards}@keyframes _ngcontent-%COMP%_bounceIn{0%{bottom:-100px;opacity:0}60%{bottom:20px;opacity:1}80%{bottom:0}to{bottom:10px;opacity:1}}@keyframes _ngcontent-%COMP%_bounceOut{0%{bottom:10px;opacity:1}20%{bottom:20px}to{bottom:-100px;opacity:0}}"]})}return o})();var qe=["chatContent"],je=(o,p)=>p.prompt;function Ge(o,p){if(o&1&&h(0,"app-info-dialog",2),o&2){let e=g();d("text",e.agentNotAvailable)("showButton",!1)}}function Ve(o,p){if(o&1){let e=E();f(0,"app-info-dialog",8),S("close",function(){w(e);let n=g();return x(n.clearInfo())}),u()}if(o&2){let e=g();d("text",e.info())}}function $e(o,p){o&1&&h(0,"div",5)}function Ue(o,p){if(o&1&&h(0,"app-bot-response",10),o&2){let e=g().$implicit;d("startPassive",!0)("content",e)}}function ze(o,p){if(o&1&&(h(0,"div",9),v(1,Ue,1,2,"app-bot-response",10)),o&2){let e=p.$implicit;d("innerHTML",e.promptHTML,j),s(),m(e.responseText?1:-1)}}function Qe(o,p){if(o&1&&h(0,"div",9)(1,"app-bot-response",10),o&2){let e=p;d("innerHTML",e.promptHTML,j),s(),d("startPassive",!1)("content",e)}}function We(o,p){o&1&&h(0,"div",6)}var dn=(()=>{class o{_assistant=c(F);_state=c(xe);_gtmService=c(Ee);chatContent;userInput="";chatHistory=this._assistant.chatHistory;currentEntry=this._assistant.currentEntry;inProgress=this._assistant.inProgress;info=l("");available=this._assistant.available;agentNotAvailable=b.AGENT_API_NOT_AVAILABLE;ignoreAgentNotAvailable=!1;onCurrentResponseUpdate=y(()=>{this.currentEntry()});searchBarHidden=l(!1);showGradientTop=l(!1);showGradientBottom=l(!1);onScroll(e){this.searchBarHidden.set(e.direction==="up"),this.showGradientTop.set(!e.isTop),this.showGradientBottom.set(!e.isBottom)}handleNoFilesNoSyncRights=y(()=>{let e=this._state.projectData();if(!e||e===void 0)return;e.lastSync===void 0&&!this._state.userCanSync()?this.info.set(N.NO_FILES_NO_SYNC_RIGHTS):this.info.set("")});ngOnInit(){this._gtmService.pushTag({event:"page_view",pageName:"chat"})}ngOnDestroy(){this._assistant.destroy()}clearInfo(){this.info.set("")}_scrollToBottom(){setTimeout(()=>{this.chatContent!==void 0&&(this.chatContent.nativeElement.scrollTop=this.chatContent.nativeElement.scrollHeight)},0)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=T({type:o,selectors:[["app-chat"]],viewQuery:function(t,n){if(t&1&&J(qe,5),t&2){let i;Y(i=Z())&&(n.chatContent=i.first)}},decls:11,vars:6,consts:[["chatContent",""],[1,"chat-container"],[3,"text","showButton"],[3,"text"],["libScrollListener","",1,"chat-content",3,"scrollEvent"],[1,"gradient","gradient-top"],[1,"gradient","gradient-bottom"],[3,"hidden"],[3,"close","text"],[1,"message",3,"innerHTML"],[3,"startPassive","content"]],template:function(t,n){if(t&1){let i=E();f(0,"div",1),v(1,Ge,1,2,"app-info-dialog",2)(2,Ve,1,1,"app-info-dialog",3),f(3,"div",4,0),S("scrollEvent",function(a){return w(i),x(n.onScroll(a))}),v(5,$e,1,0,"div",5),Q(6,ze,2,2,null,null,je),v(8,Qe,2,3)(9,We,1,0,"div",6),h(10,"app-search-bar",7),u()()}if(t&2){let i;s(),m(!n.available()&&!n.ignoreAgentNotAvailable?1:-1),s(),m(n.info()?2:-1),s(3),m(n.showGradientTop()?5:-1),s(),W(n.chatHistory()),s(2),m((i=n.currentEntry())?8:-1,i),s(),m(n.showGradientBottom()?9:-1),s(),d("hidden",n.searchBarHidden())}},dependencies:[H,Re,D,L,A,B,Be,Pe],styles:[".chat-container[_ngcontent-%COMP%]{position:relative;display:flex;flex-direction:column;justify-content:space-between;gap:10px;height:100%;overflow:hidden}.chat-content[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;margin:10px;padding:10px;scrollbar-width:none;scrollbar-gutter:stable}.chat-content[_ngcontent-%COMP%]:-webkit-scrollbar{display:none}.chat-content[_ngcontent-%COMP%]:hover{scrollbar-width:auto;margin-right:var(--qaecy-scroll-thumb-width)}.chat-content[_ngcontent-%COMP%]:hover::-webkit-scrollbar{display:block}.chat-content[_ngcontent-%COMP%]:hover::-webkit-scrollbar{width:var(--qaecy-scroll-thumb-width);background-color:#0000;margin-top:100px}.chat-content[_ngcontent-%COMP%]:hover::-webkit-scrollbar-thumb{background-color:var(--qaecy-scroll-thumb-color);border-radius:5px}.chat-content[_ngcontent-%COMP%]::-webkit-scrollbar-track{margin:20px 0}.gradient[_ngcontent-%COMP%]{position:absolute;left:0;right:0;height:120px;pointer-events:none;transition:opacity .3s ease}.gradient-bottom[_ngcontent-%COMP%]{bottom:0;background:linear-gradient(to bottom,rgba(0,0,0,0) 0%,var(--qaecy-bg-color) 100%)}.gradient-top[_ngcontent-%COMP%]{top:0;background:linear-gradient(to top,rgba(0,0,0,0) 0%,var(--qaecy-bg-color) 100%)}.message[_ngcontent-%COMP%]{margin-bottom:10px}"]})}return o})();export{dn as ChatComponent};
