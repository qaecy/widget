import{a as ie,b as se,c as re}from"./chunk-KC2TF2GP.js";import{c as te,d as oe}from"./chunk-26WL5TWN.js";import"./chunk-QEBCTBUI.js";import{c as $,g as U,i as I,j as x,k as z,o as J}from"./chunk-B4RPBFY2.js";import{a as ne}from"./chunk-IDVTS5NN.js";import{a as q}from"./chunk-22TYSVVA.js";import"./chunk-SCAGJZPO.js";import{b as Y,f as K,i as X,l as ee}from"./chunk-IIBQ532E.js";import"./chunk-VJUA2M4W.js";import"./chunk-4QWHKD6C.js";import{Eb as B,Fb as j,Gb as L,Ka as s,Lb as O,Mb as F,O as v,Pb as A,Qb as V,Rb as H,S as r,Ta as l,Ya as w,Z as S,_ as b,ac as f,bb as _,dc as y,hb as u,ja as T,jb as k,mb as g,ob as N,pb as D,qb as a,rb as d,sb as h,wb as E,yb as M,zb as C}from"./chunk-6VJMAFGR.js";import"./chunk-NC2NMBFO.js";import"./chunk-LOUWY4NJ.js";import"./chunk-4JUNAGW5.js";import{Ga as G,v as Q}from"./chunk-RIETPOXV.js";import"./chunk-5W727OWZ.js";import{v as W,z as Z}from"./chunk-SXCIL3LG.js";import"./chunk-I7PEP2DU.js";import{h as c}from"./chunk-TJICSKBO.js";var ae=(()=>{class n{parsers=re;content=T.required();startPassive=T(!0);html=l("");preLoading=f(()=>{let e=this.content().responseText;return!e||e===void 0||e===""});whileLoading=f(()=>!this.content().finished);context=f(()=>this.content().context);onTextChange=y(()=>c(this,null,function*(){let e=this.content().responseText;if(e){let t=yield ie(e);this.startPassive()===!1&&(t=this._overridePassiveMode(t)),this.html.set(t)}else this.html.set("")}));_overridePassiveMode(e){return["bim-viewer","map"].forEach(t=>{e=e.replace(`<${t}`,`<${t} [startPassive]="false"`),e=e.replace(`&lt;${t}`,`&lt;${t} [startPassive]="false"`)}),e}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=w({type:n,selectors:[["app-bot-response"]],inputs:{content:[1,"content"],startPassive:[1,"startPassive"]},decls:4,vars:7,consts:[[1,"bot-response-container"],["mode","q","size","10rem"],[1,"response"],[3,"parsers","content","context"]],template:function(t,o){t&1&&(a(0,"div",0),h(1,"app-logo",1),a(2,"div",2),h(3,"ngx-dynamic-hooks",3),d()()),t&2&&(s(2),k("loader",o.preLoading())("pulse",o.whileLoading()),s(),u("parsers",o.parsers)("content",o.html())("context",o.context()))},dependencies:[oe,se],styles:[".bot-response-container[_ngcontent-%COMP%]{display:flex;gap:.1rem;flex-direction:column;margin-bottom:1.5rem}.response[_ngcontent-%COMP%]{background-color:var(--box-bg-color);border-radius:.5rem;padding:0 .5rem;min-height:20px}.loader[_ngcontent-%COMP%]{width:.8rem;aspect-ratio:4;background:radial-gradient(circle closest-side,#fff 90%,#0000) 0/33.3333333333% 100% space;clip-path:inset(0 100% 0 0);animation:_ngcontent-%COMP%_l1 1s steps(4) infinite}@keyframes _ngcontent-%COMP%_l1{to{clip-path:inset(0 -34% 0 0)}}.pulse[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-animation 2s infinite}@keyframes _ngcontent-%COMP%_pulse-animation{0%{box-shadow:0 0 #0003}to{box-shadow:0 0 0 20px #0000}}"]})}return n})();var ce=(()=>{class n{_firebase=r(I);_storage=this._firebase.storageChatSessions;_collection=this._firebase.collectionChatSessions;_currentSession=l(void 0);_contextStore={};get currentSession(){return this._currentSession}subscribeToSession(e){if(this._collection===void 0)throw new Error(x.FIREBASE_NOT_INITIALIZED);console.info("Subscribing to chat session "+e),this._contextStore={};let t=Q(this._collection,e);return G(t,o=>c(this,null,function*(){if(o.exists()){let i=yield this._chatSessionFactory(o.data());this._currentSession.update(()=>i)}}))}getContextFile(e){return c(this,null,function*(){if(this._storage===void 0)throw new Error(x.FIREBASE_NOT_INITIALIZED);if(this._contextStore[e]!==void 0)return this._contextStore[e];console.info(`${e} not in store. Fetching from BLOB`);let t=W(this._storage,e),i=yield(yield Z(t)).text(),m=JSON.parse(i);return this._contextStore[e]=m,m})}_chatSessionFactory(e){return c(this,null,function*(){let t=new $(e.id,e.projectId,e.userId);t.created=e.created,t.updated=e.updated;for(let o of e.entries){let i=o.context,m={};i!==void 0&&i!==""?m=yield this.getContextFile(o.context):console.log("No context"),t.entries.push({id:o.id,prompt:o.prompt,responseText:o.responseText,context:m,created:o.created,updated:o.updated,finished:o.finished,error:o.error,chunkCount:o.chunkCount})}return t})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=v({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var pe=(()=>{class n{_projectService=r(z);_repo=r(ce);_firebase=r(I);_inProgress=l(!1);currentEntry=f(()=>{let e=this._repo.currentSession();return e?.entries[e.entries.length-1]??void 0});chatHistory=f(()=>{let e=this._repo.currentSession()?.entries;return e===void 0?[]:e.length===1?[]:e.slice(0,-1)},{equal:(e,t)=>e.length===t.length});_sessionUnsubscribe;_sessionId;destroy(){let e=this._sessionId;this._sessionUnsubscribe,this._sessionId=void 0,console.info("Unsubscribed from chat session "+e)}setSessionId(e){return c(this,null,function*(){this._sessionId=e,this._sessionUnsubscribe=this._repo.subscribeToSession(e)})}set searchTerm(e){this._sendPrompt(e)}get inProgress(){return this._inProgress}_sendPrompt(e){return c(this,null,function*(){if(this._firebase.functionAssistant===void 0)throw new Error(x.FIREBASE_NOT_INITIALIZED);this._inProgress.set(!0),this._sessionId===void 0&&(yield this.setSessionId(q()));let t={projectId:this._projectService.projectData()?.id,sessionId:this._sessionId,prompt:e};try{yield this._firebase.functionAssistant(t)}catch(o){console.error("Error calling Firebase function:",o)}this._inProgress.set(!1)})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=v({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var le=["chatContent"],de=(n,p)=>p.prompt;function me(n,p){if(n&1){let e=E();a(0,"app-info-dialog",6),M("close",function(){S(e);let o=C();return b(o.clearInfo())}),d()}if(n&2){let e=C();u("text",e.info())}}function fe(n,p){if(n&1&&h(0,"app-bot-response",8),n&2){let e=C().$implicit;u("startPassive",!0)("content",e)}}function ue(n,p){if(n&1&&(a(0,"div",7),O(1),d(),_(2,fe,1,2,"app-bot-response",8)),n&2){let e=p.$implicit;s(),F(e.prompt),s(),g(e.responseText?2:-1)}}function he(n,p){if(n&1&&h(0,"app-bot-response",8),n&2){let e=C();u("startPassive",!1)("content",e)}}function _e(n,p){if(n&1&&(a(0,"div",7),O(1),d(),_(2,he,1,2,"app-bot-response",8)),n&2){let e=p;s(),F(e.prompt),s(),g(e.responseText?2:-1)}}var tt=(()=>{class n{_assistant=r(pe);_state=r(J);_gtmService=r(ne);chatContent;userInput="";chatHistory=this._assistant.chatHistory;currentEntry=this._assistant.currentEntry;inProgress=this._assistant.inProgress;onCurrentResponseUpdate=y(()=>{this.currentEntry(),this.scrollToBottom()});info=l("");handleNoFilesNoSyncRights=y(()=>{let e=this._state.projectData();if(!e||e===void 0)return;e.lastSync===void 0&&!this._state.userCanSync()?this.info.set(U.NO_FILES_NO_SYNC_RIGHTS):this.info.set("")});ngOnInit(){this._gtmService.pushTag({event:"page_view",pageName:"chat"})}ngOnDestroy(){this._assistant.destroy()}clearInfo(){this.info.set("")}sendPrompt(){this.userInput.trim()!==""&&(this._assistant.searchTerm=this.userInput.trim(),this.scrollToBottom(),this.userInput="")}scrollToBottom(){setTimeout(()=>{this.chatContent!==void 0&&(this.chatContent.nativeElement.scrollTop=this.chatContent.nativeElement.scrollHeight)},0)}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=w({type:n,selectors:[["app-chat"]],viewQuery:function(t,o){if(t&1&&B(le,5),t&2){let i;j(i=L())&&(o.chatContent=i.first)}},decls:9,vars:3,consts:[["chatContent",""],[1,"chat-container"],[3,"text"],[1,"chat-content"],[1,"input-area"],["type","text","placeholder","Search or ask...",2,"max-width","80%","width","500px",3,"ngModelChange","keyup.enter","ngModel"],[3,"close","text"],[1,"message"],[3,"startPassive","content"]],template:function(t,o){if(t&1){let i=E();a(0,"div",1),_(1,me,1,1,"app-info-dialog",2),a(2,"div",3,0),N(4,ue,3,2,null,null,de),_(6,_e,3,2),d(),a(7,"div",4)(8,"input",5),H("ngModelChange",function(P){return S(i),V(o.userInput,P)||(o.userInput=P),b(P)}),M("keyup.enter",function(){return S(i),b(o.sendPrompt())}),d()()()}if(t&2){let i;s(),g(o.info()?1:-1),s(3),D(o.chatHistory()),s(2),g((i=o.currentEntry())?6:-1,i),s(2),A("ngModel",o.userInput)}},dependencies:[ee,Y,K,X,ae,te],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:space-between;gap:10px;height:100%;overflow:hidden;font-size:.8rem}input[_ngcontent-%COMP%]{outline:none;color:var(--qaecy-font-color);border:1px solid var(--qaecy-font-color);padding:1rem;border-radius:.5rem;background-color:#0000}.chat-content[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:20px}.message[_ngcontent-%COMP%]{margin-bottom:10px}.input-area[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:row;justify-content:center}"]})}return n})();export{tt as ChatComponent};
