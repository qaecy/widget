import{a as B,b as ye,c as ve,d as we,e as xe}from"./chunk-AYP6Z4BA.js";import{c as ge,d as be}from"./chunk-5DPKKYOW.js";import"./chunk-KVOAQQQH.js";import{c as L,g as T,i as se,j as O,k as w,l as de,n as le,p as pe}from"./chunk-THGINUHG.js";import{a as Ce}from"./chunk-EST3HM3H.js";import{a as oe}from"./chunk-22TYSVVA.js";import{b as k,d as he,h as ue,k as _e,n as H}from"./chunk-VY7MXYSK.js";import{P as me,Q as E,R as fe,S as R}from"./chunk-PKQBRYZK.js";import{g as te,j as ne}from"./chunk-NGJ6S4NL.js";import{Ab as y,Fb as $,Ga as N,Gb as Q,Hb as J,Jb as W,Ka as r,Kb as Z,Mb as Y,O as P,Qb as K,Rb as X,S as a,Sb as ee,Ta as s,Ua as A,Ya as x,Z as C,_ as b,bb as g,bc as h,ec as v,hb as c,ib as V,ja as I,jb as G,mb as u,pb as z,qb as U,rb as f,sb as _,tb as d,xb as M,zb as S}from"./chunk-SUJ2ERSS.js";import"./chunk-2MEMY2TC.js";import"./chunk-GSV7GFVO.js";import"./chunk-4JUNAGW5.js";import{Ca as ie,Ga as re,v as q}from"./chunk-QWYGOFBQ.js";import"./chunk-VNCJOYNM.js";import{v as ae,z as ce}from"./chunk-I4ID7IWF.js";import"./chunk-36JE2O54.js";import{a as j}from"./chunk-DAQOROHW.js";function Te(o,l){if(o&1&&d(0,"app-doc-refs",4),o&2){let e=y();c("data",e.docRefs())("highlighted",e.highlightedRef())}}var Se=(()=>{class o{parsers=ve;content=I.required();startPassive=I(!0);html=s("");preLoading=h(()=>{let e=this.content().responseText;return!e||e===void 0||e===""});whileLoading=h(()=>!this.content().finished);context=h(()=>this._overrideContext(this.content().context));docRefs=h(()=>{let e=this.context().refs;return e!==void 0?e:[]});highlightedRef=s("");onTextChange=v(async()=>{let e=this.content().responseText;if(e){let t=await B(e);this.startPassive()===!1&&(t=this._overridePassiveMode(t),t=this._overrideRefOutput(t)),this.html.set(t)}else this.html.set("")});_overridePassiveMode(e){return["bim-viewer","map"].forEach(t=>{e=e.replace(new RegExp(`<${t}`,"g"),`<${t} [startPassive]="false"`),e=e.replace(new RegExp(`&lt;${t}`,"g"),`&lt;${t} [startPassive]="false"`)}),e}_overrideRefOutput(e){return e=e.replace(/<ref/g,"<ref (hovered)=context.qaecyRefHoverHandler($event) (clicked)=context.qaecyRefClickHandler($event)"),e}_overrideContext(e){if(e!==void 0)return e.qaecyRefHoverHandler=t=>{let i=(t!==void 0?this._getRefFromIndex(e,t):void 0)?.documentId??"";this.highlightedRef.set(i)},e.qaecyRefClickHandler=t=>{let n=this._getRefFromIndex(e,t);console.log("Clicked ref"),console.log(n)},e}_getRefFromIndex(e,t){let n=e.refs;if(n!==void 0)return n[t]}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=x({type:o,selectors:[["app-bot-response"]],inputs:{content:[1,"content"],startPassive:[1,"startPassive"]},decls:5,vars:8,consts:[[1,"bot-response-container"],["mode","q","size","10rem"],[1,"response"],[3,"parsers","content","context"],[3,"data","highlighted"]],template:function(t,n){t&1&&(f(0,"div",0),d(1,"app-logo",1),f(2,"div",2),d(3,"ngx-dynamic-hooks",3),_(),g(4,Te,1,2,"app-doc-refs",4),_()),t&2&&(r(2),G("loader",n.preLoading())("pulse",n.whileLoading()),r(),c("parsers",n.parsers)("content",n.html())("context",n.context()),r(),u(n.docRefs().length?4:-1))},dependencies:[be,ye,we],styles:[".bot-response-container[_ngcontent-%COMP%]{display:flex;gap:.1rem;flex-direction:column;margin-bottom:1.5rem}.response[_ngcontent-%COMP%]{background-color:var(--box-bg-color);border-radius:.5rem;padding:0 .5rem;min-height:20px}.loader[_ngcontent-%COMP%]{width:.8rem;aspect-ratio:4;background:radial-gradient(circle closest-side,#fff 90%,#0000) 0/33.3333333333% 100% space;clip-path:inset(0 100% 0 0);animation:_ngcontent-%COMP%_l1 1s steps(4) infinite}@keyframes _ngcontent-%COMP%_l1{to{clip-path:inset(0 -34% 0 0)}}.pulse[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-animation 2s infinite}@keyframes _ngcontent-%COMP%_pulse-animation{0%{box-shadow:0 0 #0003}to{box-shadow:0 0 0 20px #0000}}"]})}return o})();var Ie=(()=>{class o{_firebase=a(O);_storage=this._firebase.storageChatSessions;_collection=this._firebase.collectionChatSessions;_currentSession=s(void 0);_contextStore={};get currentSession(){return this._currentSession}subscribeToSession(e){if(this._collection===void 0)throw new Error(w.FIREBASE_NOT_INITIALIZED);console.info("Subscribing to chat session "+e),this._contextStore={};let t=q(this._collection,e);return re(t,async n=>{if(n.exists()){let i=await this._chatSessionFactory(n.data());this._currentSession.update(()=>i)}})}async getContextFile(e){if(this._storage===void 0)throw new Error(w.FIREBASE_NOT_INITIALIZED);if(this._contextStore[e]!==void 0)return this._contextStore[e];console.info(`${e} not in store. Fetching from BLOB`);let t=ae(this._storage,e),i=await(await ce(t)).text(),p=JSON.parse(i);return this._contextStore[e]=p,p;return{}}async createChatSessionIfNotExists(e,t,n){if(this._collection===void 0)throw new Error(w.FIREBASE_NOT_INITIALIZED);console.info(T.CREATING_CHAT_SESSION);let i=new L(e,t,n),p=q(this._collection,i.id);try{await ie(p,j({},i)),console.info(T.CHAT_SESSION_CREATED)}catch(m){console.warn(m)}}async _chatSessionFactory(e){let t=new L(e.id,e.projectId,e.userId);t.created=e.created,t.updated=e.updated;for(let n of e.entries){let i=n.context,p={};i!==void 0&&i!==""&&(p=await this.getContextFile(n.context)),t.entries.push({id:n.id,prompt:n.prompt,promptHTML:await B(n.prompt),responseText:n.responseText,context:p,created:n.created,updated:n.updated,finished:n.finished,error:n.error,chunkCount:n.chunkCount})}return t}static \u0275fac=function(t){return new(t||o)};static \u0275prov=P({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var D=(()=>{class o{_projectService=a(de);_userService=a(le);_repo=a(Ie);_firebase=a(O);_inProgress=s(!1);currentEntry=h(()=>{let e=this._repo.currentSession();return e?.entries[e.entries.length-1]??void 0});chatHistory=h(()=>{let e=this._repo.currentSession()?.entries;return e===void 0?[]:e.length===1?[]:e.slice(0,-1)},{equal:(e,t)=>e.length===t.length});_projectId=h(()=>this._projectService.projectData()?.id);_userId=h(()=>this._userService.userData()?.id);_sessionUnsubscribe;_sessionId;destroy(){let e=this._sessionId;this._sessionUnsubscribe,this._sessionId=void 0,console.info("Unsubscribed from chat session "+e)}async setSessionId(e){this._sessionId=e;let t=this._projectId(),n=this._userId();if(t===void 0)throw new Error(w.MISSING_PROJECT_ID);if(n===void 0)throw new Error(w.MISSING_USER_ID);await this._repo.createChatSessionIfNotExists(e,t,n),this._sessionUnsubscribe=this._repo.subscribeToSession(e)}set searchTerm(e){this._sendPrompt(e)}get inProgress(){return this._inProgress}async _sendPrompt(e){this._inProgress.set(!0),this._sessionId===void 0&&await this.setSessionId(oe());let t={spaceId:this._projectId(),id:this._sessionId,userId:this._userId(),prompt:e},n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};try{await this._firebase.sendRequest(se,"POST",t)}catch(i){console.error("Error calling Firebase function:",i)}this._inProgress.set(!1)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=P({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var Pe=["textarea"],Me=(()=>{class o{_assistant=a(D);hidden=I(!1);userInput="";showHideClass=s("");_textarea=A("textarea");animateOnHiddenToggled=v(()=>{this.hidden()?this.showHideClass.set("hide"):this.showHideClass.set("show")});ngAfterViewInit(){this._textarea()?.nativeElement.addEventListener("input",e=>{let t=e.target;t.style.height="auto",t.style.height=t.scrollHeight+"px"})}sendPrompt(e){if(e.preventDefault(),this.userInput.trim()!==""){this._assistant.searchTerm=this.userInput.trim(),this.userInput="";let t=this._textarea()?.nativeElement;t.style.height="auto"}}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=x({type:o,selectors:[["app-search-bar"]],viewQuery:function(t,n){t&1&&W(n._textarea,Pe,5),t&2&&Z()},inputs:{hidden:[1,"hidden"]},decls:8,vars:5,consts:[["textarea",""],[1,"search-bar-container",3,"ngClass"],[1,"search-bar-inner-container"],[1,"input-area"],["matInput","","placeholder","Search or ask...","rows","1",3,"ngModelChange","keydown.enter","ngModel"],["mat-icon-button","","aria-label","Send prompt",3,"click","disabled"]],template:function(t,n){if(t&1){let i=M();f(0,"div",1)(1,"div",2)(2,"div",3)(3,"textarea",4,0),ee("ngModelChange",function(m){return C(i),X(n.userInput,m)||(n.userInput=m),b(m)}),S("keydown.enter",function(m){return C(i),b(n.sendPrompt(m))}),_(),f(5,"button",5),S("click",function(m){return C(i),b(n.sendPrompt(m))}),f(6,"mat-icon"),Y(7,"start"),_()()()()()}t&2&&(c("ngClass",n.showHideClass()),r(),V("border",n.userInput?"none":"0.01rem solid var(--qaecy-font-color)"),r(2),K("ngModel",n.userInput),r(2),c("disabled",!n.userInput))},dependencies:[ne,te,H,he,ue,_e,k,R,fe,E,me],styles:[".search-bar-container[_ngcontent-%COMP%]{position:absolute;bottom:0;left:0;right:0;width:100%;display:flex;flex-direction:row;justify-content:center;transition:opacity .3s ease-in-out}.search-bar-inner-container[_ngcontent-%COMP%]{-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(6px);box-shadow:var(--frosted-shadow);border-radius:1rem;width:80%;max-width:400px;padding:calc(var(--qaecy-font-size) * .2)}.input-area[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center;gap:.5rem;justify-content:center}.input-area[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{font-size:var(--qaecy-font-size);font-family:var(--qaecy-font-family);border:1px solid;border-radius:.3rem;border-color:#0000;color:var(--qaecy-font-color);outline:none;background-color:#0000;padding:.5rem;width:85%;max-width:800px;max-height:calc(var(--qaecy-font-size) * 10);scrollbar-width:none;scrollbar-gutter:stable;transition:height .3s ease;resize:none}textarea[_ngcontent-%COMP%]:-webkit-scrollbar{display:none}.search-bar-container.show[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_bounceIn .6s ease-out forwards}.search-bar-container.hide[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_bounceOut .6s ease-in forwards}@keyframes _ngcontent-%COMP%_bounceIn{0%{bottom:-100px;opacity:0}60%{bottom:20px;opacity:1}80%{bottom:0}to{bottom:10px;opacity:1}}@keyframes _ngcontent-%COMP%_bounceOut{0%{bottom:10px;opacity:1}20%{bottom:20px}to{bottom:-100px;opacity:0}}"]})}return o})();var Oe=["chatContent"],Ee=(o,l)=>l.prompt;function Re(o,l){if(o&1){let e=M();f(0,"app-info-dialog",7),S("close",function(){C(e);let n=y();return b(n.clearInfo())}),_()}if(o&2){let e=y();c("text",e.info())}}function ke(o,l){o&1&&d(0,"div",4)}function He(o,l){if(o&1&&d(0,"app-bot-response",9),o&2){let e=y().$implicit;c("startPassive",!0)("content",e)}}function Be(o,l){if(o&1&&(d(0,"div",8),g(1,He,1,2,"app-bot-response",9)),o&2){let e=l.$implicit;c("innerHTML",e.promptHTML,N),r(),u(e.responseText?1:-1)}}function Fe(o,l){if(o&1&&d(0,"app-bot-response",9),o&2){let e=y();c("startPassive",!1)("content",e)}}function De(o,l){if(o&1&&(d(0,"div",8),g(1,Fe,1,2,"app-bot-response",9)),o&2){let e=l;c("innerHTML",e.promptHTML,N),r(),u(e.responseText?1:-1)}}function Ne(o,l){o&1&&d(0,"div",5)}var Vt=(()=>{class o{_assistant=a(D);_state=a(pe);_gtmService=a(Ce);chatContent;userInput="";chatHistory=this._assistant.chatHistory;currentEntry=this._assistant.currentEntry;inProgress=this._assistant.inProgress;onCurrentResponseUpdate=v(()=>{this.currentEntry(),this._scrollToBottom()});info=s("");searchBarHidden=s(!1);showGradientTop=s(!1);showGradientBottom=s(!1);onScroll(e){this.searchBarHidden.set(e.direction==="up"),this.showGradientTop.set(!e.isTop),this.showGradientBottom.set(!e.isBottom)}handleNoFilesNoSyncRights=v(()=>{let e=this._state.projectData();if(!e||e===void 0)return;e.lastSync===void 0&&!this._state.userCanSync()?this.info.set(T.NO_FILES_NO_SYNC_RIGHTS):this.info.set("")});ngOnInit(){this._gtmService.pushTag({event:"page_view",pageName:"chat"})}ngOnDestroy(){this._assistant.destroy()}clearInfo(){this.info.set("")}_scrollToBottom(){setTimeout(()=>{this.chatContent!==void 0&&(this.chatContent.nativeElement.scrollTop=this.chatContent.nativeElement.scrollHeight)},0)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=x({type:o,selectors:[["app-chat"]],viewQuery:function(t,n){if(t&1&&$(Oe,5),t&2){let i;Q(i=J())&&(n.chatContent=i.first)}},decls:10,vars:5,consts:[["chatContent",""],[1,"chat-container"],[3,"text"],["libScrollListener","",1,"chat-content",3,"scrollEvent"],[1,"gradient","gradient-top"],[1,"gradient","gradient-bottom"],[3,"hidden"],[3,"close","text"],[1,"message",3,"innerHTML"],[3,"startPassive","content"]],template:function(t,n){if(t&1){let i=M();f(0,"div",1),g(1,Re,1,1,"app-info-dialog",2),f(2,"div",3,0),S("scrollEvent",function(m){return C(i),b(n.onScroll(m))}),g(4,ke,1,0,"div",4),z(5,Be,2,2,null,null,Ee),g(7,De,2,2)(8,Ne,1,0,"div",5),d(9,"app-search-bar",6),_()()}if(t&2){let i;r(),u(n.info()?1:-1),r(3),u(n.showGradientTop()?4:-1),r(),U(n.chatHistory()),r(2),u((i=n.currentEntry())?7:-1,i),r(),u(n.showGradientBottom()?8:-1),r(),c("hidden",n.searchBarHidden())}},dependencies:[H,Se,ge,k,E,R,Me,xe],styles:[".chat-container[_ngcontent-%COMP%]{position:relative;display:flex;flex-direction:column;justify-content:space-between;gap:10px;height:100%;overflow:hidden}.chat-content[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;margin:10px;padding:10px;scrollbar-width:none;scrollbar-gutter:stable}.chat-content[_ngcontent-%COMP%]:-webkit-scrollbar{display:none}.chat-content[_ngcontent-%COMP%]:hover{scrollbar-width:auto}.chat-content[_ngcontent-%COMP%]:hover::-webkit-scrollbar{display:block}.chat-content[_ngcontent-%COMP%]:hover::-webkit-scrollbar{width:var(--qaecy-scroll-thumb-width);background-color:#0000;margin-top:100px}.chat-content[_ngcontent-%COMP%]:hover::-webkit-scrollbar-thumb{background-color:var(--qaecy-scroll-thumb-color);border-radius:5px}.chat-content[_ngcontent-%COMP%]::-webkit-scrollbar-track{margin:20px 0}.gradient[_ngcontent-%COMP%]{position:absolute;left:0;right:0;height:120px;pointer-events:none;transition:opacity .3s ease}.gradient-bottom[_ngcontent-%COMP%]{bottom:0;background:linear-gradient(to bottom,rgba(0,0,0,0) 0%,var(--qaecy-bg-color) 100%)}.gradient-top[_ngcontent-%COMP%]{top:0;background:linear-gradient(to top,rgba(0,0,0,0) 0%,var(--qaecy-bg-color) 100%)}.message[_ngcontent-%COMP%]{margin-bottom:10px}"]})}return o})();export{Vt as ChatComponent};
