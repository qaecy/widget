import{a as D,b,c as j}from"./chunk-VEDCF245.js";import{h as m,i as g,j as c,k as S,n as I}from"./chunk-QK5VUW5Z.js";import{O as h,S as r,Ta as p,bc as f,cc as l}from"./chunk-C37SL542.js";import{m as y,v as _}from"./chunk-SXCIL3LG.js";import{a as u,h as d}from"./chunk-TJICSKBO.js";var w=(()=>{class n{_firebase=r(g);_storage=this._firebase.storageRaw;uploadData(e,t){return d(this,null,function*(){if(this._storage===void 0)throw new Error(c.FIREBASE_NOT_INITIALIZED);let s=yield this._getDocumentUUID(e.buffer),o=_(this._storage,`${t.space_id}/${s}${t.suffix}`);yield y(o,e,{customMetadata:u({},t)})})}_getDocumentUUID(e){return d(this,null,function*(){let t=yield j(e);return D(t)})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=h({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var q=(()=>{class n{_options=r(I);_storage=r(w);_auth=r(m);_proj=r(S);_hostList=p([]);hostListEnriched=f(()=>{let e=this._options.options().hostApp;return this._hostList().map(t=>Object.assign({fileUUID:b(t.relativePath,e)},t))});hostSyncObject=f(()=>{if(!this.hostListEnriched().length)return;let e={};return this.hostListEnriched().forEach(t=>{e[t.fileUUID]=t.modified}),e});serverSyncObject=f(()=>this._proj.projectData()?.syncDetails);syncTable=f(()=>{if(this.hostSyncObject()===void 0)return[];let t=this.serverSyncObject()??{};return this.hostListEnriched().map(s=>{let o=t[s.fileUUID],a=o!==void 0,i=!a||new Date(s.modified)>new Date(o);return Object.assign({synced:a,outdated:i,lastSync:o},s)})});_pendingFileSync=l(()=>{let e=this.syncTable();if(!e.length)return!1;let t=e.filter(s=>s.outdated);return t.length===0&&console.info(`Received ${e.length} files from host but all of them were up to date`),t.length>0});_syncPct=p(0);_syncDone=p(!1);get syncPct(){return this._syncPct}get syncDone(){return this._syncDone}set hostList(e){this._hostList.update(()=>[...e])}get hostList(){return this._hostList}get pendingFileSync(){return this._pendingFileSync}dismissPendingFileSync(){this._pendingFileSync.set(!1)}sync(e){return d(this,null,function*(){let t=this._proj.projectData();if(!t||t===void 0)throw new Error(c.MISSING_PROJECT_DATA);let s=t.id;if(s===void 0)throw new Error(c.MISSING_PROJECT_ID);let o=this._auth.user()?.uid;if(o===void 0)throw new Error(c.MISSING_USER_ID);let a=0;for(let i of e){let U=i.name.split(".").pop()??"",E={uploaded_by:o,suffix:`.${U}`,space_id:s,name:i.relativePath,last_seen_as:JSON.stringify({host:this._options.options().hostApp,fileUUID:i.fileUUID}),additional_metadata:JSON.stringify({name:i.name,created:i.created,createdBy:i.createdBy,modified:i.modified,modifiedBy:i.modifiedBy})},O=yield i.data(i.iri);yield this._storage.uploadData(O,E),a++,this._syncPct.set(Math.round(a/e.length*100))}this._syncDone.set(!0),this._pendingFileSync.set(!1),this._hostList.set([])})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=h({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();export{q as a};
