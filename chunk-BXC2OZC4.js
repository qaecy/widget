import{a as I,b as D,c as b}from"./chunk-A2LSBBSI.js";import{h as l,l as _,m as c,n as g,q as S}from"./chunk-R3WPWP4T.js";import{O as f,S as r,Ta as h,bc as d,cc as u}from"./chunk-SUJ2ERSS.js";import{m,v as y}from"./chunk-I4ID7IWF.js";import{a as p}from"./chunk-DAQOROHW.js";var j=(()=>{class n{_firebase=r(_);_storage=this._firebase.storageRaw;async uploadData(e,t){if(this._storage===void 0)throw new Error(c.FIREBASE_NOT_INITIALIZED);let s=await this._getDocumentUUID(e.buffer),o=y(this._storage,`${t.space_id}/${s}${t.suffix}`);await m(o,e,{customMetadata:p({},t)})}async _getDocumentUUID(e){let t=await b(e);return I(t)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var Z=(()=>{class n{_options=r(S);_storage=r(j);_auth=r(l);_proj=r(g);_hostList=h([]);hostListEnriched=d(()=>{let e=this._options.options().hostApp;return this._hostList().map(t=>Object.assign({fileUUID:D(t.relativePath,e)},t))});hostSyncObject=d(()=>{if(!this.hostListEnriched().length)return;let e={};return this.hostListEnriched().forEach(t=>{e[t.fileUUID]=t.modified}),e});serverSyncObject=d(()=>this._proj.projectData()?.syncDetails);syncTable=d(()=>{if(this.hostSyncObject()===void 0)return[];let t=this.serverSyncObject()??{};return this.hostListEnriched().map(s=>{let o=t[s.fileUUID],a=o!==void 0,i=!a||new Date(s.modified)>new Date(o);return Object.assign({synced:a,outdated:i,lastSync:o},s)})});_pendingFileSync=u(()=>{let e=this.syncTable();if(!e.length)return!1;let t=e.filter(s=>s.outdated);return t.length===0&&console.info(`Received ${e.length} files from host but all of them were up to date`),t.length>0});_syncPct=h(0);_syncDone=h(!1);get syncPct(){return this._syncPct}get syncDone(){return this._syncDone}set hostList(e){this._hostList.update(()=>[...e])}get hostList(){return this._hostList}get pendingFileSync(){return this._pendingFileSync}dismissPendingFileSync(){this._pendingFileSync.set(!1)}async sync(e){let t=this._proj.projectData();if(!t||t===void 0)throw new Error(c.MISSING_PROJECT_DATA);let s=t.id;if(s===void 0)throw new Error(c.MISSING_PROJECT_ID);let o=this._auth.user()?.uid;if(o===void 0)throw new Error(c.MISSING_USER_ID);let a=0;for(let i of e){let w=i.name.split(".").pop()??"",U={uploaded_by:o,suffix:`.${w}`,space_id:s,name:i.relativePath,last_seen_as:JSON.stringify({host:this._options.options().hostApp,fileUUID:i.fileUUID}),additional_metadata:JSON.stringify({name:i.name,created:i.created,createdBy:i.createdBy,modified:i.modified,modifiedBy:i.modifiedBy})},E=await i.data(i.iri);await this._storage.uploadData(E,U),a++,this._syncPct.set(Math.round(a/e.length*100))}this._syncDone.set(!0),this._pendingFileSync.set(!1),this._hostList.set([])}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();export{Z as a};
